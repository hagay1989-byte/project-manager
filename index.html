<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Project Manager V55 - Fixed Header</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700;900&display=swap" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <style>
        body { font-family: 'Heebo', sans-serif; background-color: #f0f2f5; -webkit-tap-highlight-color: transparent; }
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        .glass-header { background: #ffffff; border-bottom: 1px solid #e5e7eb; box-shadow: 0 1px 2px rgba(0,0,0,0.02); }
        .tab-btn { border-bottom: 3px solid transparent; color: #6b7280; padding: 10px 15px; transition: all 0.2s; font-weight: 500; font-size: 0.9rem; cursor: pointer; white-space: nowrap; }
        .tab-btn.active { border-bottom-color: #2563eb; color: #2563eb; background-color: #eff6ff; }
        .tab-content { display: none; height: 100%; }
        .tab-content.active { display: flex; flex-direction: column; animation: fadeIn 0.2s ease-out; }
        
        /* Gantt Styles */
        .timeline-container { display: flex; flex-direction: column; height: 100%; overflow: hidden; background: white; position: relative; }
        .timeline-scroll-area { overflow: auto; flex: 1; position: relative; }
        .timeline-header { display: flex; border-bottom: 1px solid #e5e7eb; background-color: #f9fafb; font-size: 0.75rem; color: #6b7280; font-weight: bold; min-width: max-content; }
        .timeline-header-cell { width: 40px; text-align: center; padding: 8px 0; border-right: 1px solid #f3f4f6; flex-shrink: 0; }
        .timeline-body { position: relative; min-width: max-content; }
        .timeline-row { display: flex; border-bottom: 1px solid #f3f4f6; height: 44px; align-items: center; position: relative; transition: background 0.1s; }
        .timeline-row:hover { background-color: #f8fafc; }
        .timeline-row.task-row { height: 32px; background-color: #fcfcfc; border-bottom: 1px dashed #f0f0f0; }
        .sticky-col { position: sticky; right: 0; background: white; z-index: 20; border-left: 1px solid #e5e7eb; box-shadow: -2px 0 5px rgba(0,0,0,0.05); width: 160px; flex-shrink: 0; display: flex; align-items: center; padding: 0 8px; height: 100%; }
        @media (max-width: 640px) { .sticky-col { width: 130px; font-size: 0.75rem; } .timeline-header-cell { width: 30px; } }
        .timeline-bar { position: absolute; top: 8px; height: 28px; border-radius: 6px; font-size: 0.7rem; color: white; display: flex; align-items: center; padding: 0 6px; white-space: nowrap; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer; z-index: 10; }
        .gantt-milestone { position: absolute; top: 50%; transform: translate(-50%, -50%) rotate(45deg); width: 10px; height: 10px; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.2); z-index: 30; cursor: pointer; }
        .expand-btn { width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; border-radius: 4px; color: #94a3b8; cursor: pointer; border: 1px solid #e2e8f0; background: #f8fafc; margin-left: 6px; flex-shrink: 0; }

        /* Internal Project Timeline Styles */
        .project-timeline-track { background-color: #f8fafc; border-radius: 12px; height: 48px; position: relative; overflow: hidden; box-shadow: inset 0 2px 6px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; margin-top: 10px; }
        .project-timeline-bar { position: absolute; top: 0; bottom: 0; left: 0; width: 100%; background: transparent; } 
        .mini-milestone { position: absolute; top: 50%; width: 14px; height: 14px; transform: translate(-50%, -50%) rotate(45deg); border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.15); z-index: 20; cursor: pointer; transition: transform 0.2s; }
        .mini-milestone:hover { transform: translate(-50%, -50%) rotate(45deg) scale(1.5); z-index: 30; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes scaleUp { from { transform: scale(0.98); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .animate-modal { animation: scaleUp 0.15s ease-out forwards; }
    </style>
</head>
<body class="text-gray-800 h-screen flex flex-col overflow-hidden text-sm md:text-base">

    <div id="loginScreen" class="fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-70 backdrop-blur-sm z-50 p-4">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center">
            <h2 id="authTitle" class="text-2xl font-bold mb-6 text-gray-800">×›× ×™×¡×” ×œ××¢×¨×›×ª</h2>
            <div id="authError" class="hidden bg-red-50 border border-red-100 text-red-600 p-3 rounded-lg mb-4 text-xs"></div>
            <div class="space-y-4">
                <input type="email" id="emailInput" placeholder="××™××™×™×œ" class="w-full px-4 py-3 rounded-xl border border-gray-200 outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition" dir="ltr">
                <input type="password" id="passInput" placeholder="×¡×™×¡××”" class="w-full px-4 py-3 rounded-xl border border-gray-200 outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition" dir="ltr">
                <button id="authBtn" onclick="handleAuthAction()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-lg transition active:scale-95">×”×ª×—×‘×¨</button>
            </div>
            <div class="mt-6 text-center text-xs">
                <span id="authToggleText" class="text-gray-500">××™×Ÿ ×œ×š ×—×©×‘×•×Ÿ? </span>
                <button onclick="toggleAuthMode()" id="authToggleLink" class="text-blue-600 font-bold hover:underline cursor-pointer">×”×™×¨×©× ×›××Ÿ</button>
            </div>
        </div>
    </div>

    <div id="app" class="hidden flex-col h-full w-full">
        <header class="glass-header z-30 flex-shrink-0">
            <div class="max-w-7xl mx-auto px-4 py-3 md:py-4">
                
                <div class="flex flex-col md:flex-row justify-between items-center mb-3 gap-3 md:gap-4">
                    
                    <div class="flex items-center justify-between w-full md:w-auto">
                        <div class="flex items-center gap-3">
                            <div class="bg-blue-600 text-white p-2 rounded-xl shadow-md"><i class="fas fa-layer-group text-lg"></i></div>
                            <div>
                                <h1 class="text-xl md:text-2xl font-bold text-gray-900 leading-none">× ×™×”×•×œ ×¤×¨×•×™×§×˜×™×</h1>
                                <p class="text-[10px] md:text-xs text-gray-500 mt-0.5 font-medium">×”×—×‘×¨×” ×”×¢×™×¨×•× ×™×ª ×œ×ª×™×™×¨×•×ª</p>
                            </div>
                        </div>
                        <button onclick="auth.signOut()" class="md:hidden text-gray-400 bg-gray-50 p-2 rounded-lg"><i class="fas fa-sign-out-alt"></i></button>
                    </div>
                    
                    <div class="flex flex-col-reverse md:flex-row items-center gap-3 w-full md:w-auto">
                        
                        <div class="grid grid-cols-2 sm:grid-cols-4 md:flex gap-2 w-full md:w-auto">
                            <button onclick="openGanttModal()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-xl text-xs md:text-sm font-bold flex items-center justify-center gap-2 shadow-sm transition hover:-translate-y-0.5"><i class="fas fa-calendar-alt"></i> ×’×× ×˜</button>
                            <button onclick="openAnalyticsModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-xl text-xs md:text-sm font-bold flex items-center justify-center gap-2 shadow-sm transition hover:-translate-y-0.5"><i class="fas fa-chart-pie"></i> ×“×©×‘×•×¨×“</button>
                            <button onclick="exportToExcel()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-xl text-xs md:text-sm font-bold flex items-center justify-center gap-2 shadow-sm transition hover:-translate-y-0.5"><i class="fas fa-file-excel"></i> ××§×¡×œ</button>
                            <button onclick="openNewProjectModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl text-xs md:text-sm font-bold flex items-center justify-center gap-2 shadow-sm transition hover:-translate-y-0.5">
                                <i class="fas fa-plus"></i> 
                                <span class="hidden md:inline">×¤×¨×•×™×§×˜ ×—×“×©</span> <span class="md:hidden">×—×“×©</span> </button>
                        </div>

                        <div class="hidden md:flex items-center gap-3 border-r pr-3 mr-1">
                            <span id="userEmailDisplay" class="text-xs text-gray-500 font-mono bg-gray-50 px-3 py-1.5 rounded-lg border border-gray-100"></span>
                            <div id="adminBadge" class="hidden bg-red-100 text-red-600 text-[10px] font-bold px-2 py-1 rounded border border-red-200">ADMIN</div>
                            <button onclick="auth.signOut()" class="text-gray-400 hover:text-red-500 p-2 transition bg-gray-50 rounded-lg hover:bg-red-50" title="×”×ª× ×ª×§"><i class="fas fa-sign-out-alt text-lg"></i></button>
                        </div>
                    </div>
                </div>
                
                <div class="flex flex-col sm:flex-row justify-between items-center gap-2">
                    <div class="bg-gray-100 p-1 rounded-xl flex border border-gray-200 w-full sm:w-auto">
                        <button onclick="switchView('list')" id="viewBtnList" class="flex-1 sm:flex-none px-4 py-1.5 text-xs font-bold rounded-lg flex justify-center items-center gap-2"><i class="fas fa-list"></i> ×¨×©×™××”</button>
                        <button onclick="switchView('kanban')" id="viewBtnKanban" class="flex-1 sm:flex-none px-4 py-1.5 text-xs font-bold rounded-lg flex justify-center items-center gap-2"><i class="fas fa-columns"></i> ×œ×•×—</button>
                    </div>
                    <div class="flex gap-2 w-full sm:w-auto">
                        <select id="filterDept" onchange="renderProjects()" class="flex-1 sm:flex-none bg-white border border-gray-200 text-gray-700 text-xs rounded-xl px-3 py-1.5 outline-none"><option value="all">×›×œ ×”××—×œ×§×•×ª</option></select>
                        <select id="filterStatus" onchange="renderProjects()" class="flex-1 sm:flex-none bg-white border border-gray-200 text-gray-700 text-xs rounded-xl px-3 py-1.5 outline-none"><option value="all">×›×œ ×”×¡×˜×˜×•×¡×™×</option></select>
                    </div>
                </div>
            </div>
        </header>

        <main id="mainContent" class="flex-1 max-w-7xl mx-auto w-full px-4 md:px-6 py-4 md:py-8 overflow-y-auto custom-scrollbar"></main>
    </div>

    <div id="ganttModal" class="fixed inset-0 bg-gray-900 bg-opacity-80 hidden items-center justify-center z-50 p-2 md:p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-7xl h-full md:h-[90vh] flex flex-col shadow-2xl animate-modal overflow-hidden">
            <div class="p-3 md:p-4 border-b border-gray-100 flex flex-col md:flex-row justify-between items-center bg-white shadow-sm z-10 gap-3">
                <div class="flex items-center justify-between w-full md:w-auto">
                     <div class="flex items-center gap-3">
                         <div class="bg-purple-600 text-white p-1.5 md:p-2 rounded-lg"><i class="fas fa-calendar-alt text-sm md:text-lg"></i></div>
                         <div><h3 class="text-base md:text-xl font-black text-gray-800">×’×× ×˜</h3><p class="text-[10px] text-gray-500 hidden md:block">×”×—×‘×¨×” ×”×¢×™×¨×•× ×™×ª</p></div>
                     </div>
                     <button onclick="document.getElementById('ganttModal').classList.add('hidden')" class="md:hidden bg-gray-100 text-gray-500 p-2 rounded-lg"><i class="fas fa-times"></i></button>
                </div>
                
                <div class="flex items-center gap-2 bg-gray-50 p-1 rounded-xl border border-gray-200 w-full md:w-auto justify-center">
                    <button onclick="changeGanttMonth(-1)" class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-white"><i class="fas fa-chevron-right"></i></button>
                    <span id="ganttMonthLabel" class="font-bold text-gray-700 w-28 text-center select-none text-sm"></span>
                    <button onclick="changeGanttMonth(1)" class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-white"><i class="fas fa-chevron-left"></i></button>
                </div>

                <div class="flex items-center gap-2 w-full md:w-auto">
                    <button onclick="downloadGanttImage()" class="flex-1 md:flex-none bg-blue-50 text-blue-600 p-2 rounded-xl text-xs font-bold border border-blue-100 flex items-center justify-center gap-2"><i class="fas fa-camera"></i> <span class="md:hidden">×©××•×¨</span></button>
                    <select id="ganttDeptFilter" onchange="renderGanttCalendar()" class="flex-[2] md:flex-none bg-gray-50 border border-gray-200 text-gray-700 text-xs rounded-xl px-2 py-2 outline-none"></select>
                    <button onclick="document.getElementById('ganttModal').classList.add('hidden')" class="hidden md:flex bg-gray-100 hover:bg-red-50 text-gray-500 hover:text-red-500 w-9 h-9 items-center justify-center rounded-xl transition"><i class="fas fa-times text-lg"></i></button>
                </div>
            </div>
            
            <div class="px-3 py-2 bg-gray-50 border-b flex flex-wrap gap-3 text-[10px] md:text-xs font-medium text-gray-500">
                <div class="flex items-center gap-1"><div class="w-2.5 h-2.5 bg-green-500 transform rotate-45 border border-white"></div> ×‘×•×¦×¢</div>
                <div class="flex items-center gap-1"><div class="w-2.5 h-2.5 bg-red-500 transform rotate-45 border border-white"></div> ××™×—×•×¨</div>
                <div class="flex items-center gap-1"><div class="w-2.5 h-2.5 bg-yellow-400 transform rotate-45 border border-white"></div> ×œ×‘×™×¦×•×¢</div>
            </div>

            <div class="flex-1 overflow-hidden flex flex-col bg-white">
                <div id="calendarGrid" class="timeline-container w-full h-full"></div>
            </div>
        </div>
    </div>

    <div id="analyticsModal" class="fixed inset-0 bg-gray-900 bg-opacity-80 hidden items-center justify-center z-50 p-2 md:p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-6xl h-full md:h-[90vh] flex flex-col shadow-2xl animate-modal overflow-hidden">
            <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-white flex-shrink-0">
                <h3 class="text-lg md:text-2xl font-black text-gray-800 flex items-center gap-2"><i class="fas fa-chart-pie text-indigo-600"></i> ×“×©×‘×•×¨×“</h3>
                <button onclick="document.getElementById('analyticsModal').classList.add('hidden')" class="bg-gray-50 hover:bg-gray-100 p-2 rounded-lg transition"><i class="fas fa-times text-gray-500"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto bg-gray-50 p-4 md:p-8 custom-scrollbar">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-6 mb-6 md:mb-8">
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 text-center"><div class="text-[10px] md:text-xs text-gray-400 font-bold uppercase mb-1">×ª×§×¦×™×‘</div><div class="text-xl md:text-3xl font-black text-indigo-600" id="totalBudgetDisplay">0</div></div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 text-center"><div class="text-[10px] md:text-xs text-gray-400 font-bold uppercase mb-1">×¤×¨×•×™×§×˜×™×</div><div class="text-xl md:text-3xl font-black text-gray-800" id="totalProjectsDisplay">0</div></div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 text-center"><div class="text-[10px] md:text-xs text-gray-400 font-bold uppercase mb-1">×‘×‘×™×¦×•×¢</div><div class="text-xl md:text-3xl font-black text-blue-500" id="activeProjectsDisplay">0</div></div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 text-center"><div class="text-[10px] md:text-xs text-gray-400 font-bold uppercase mb-1">×‘×¡×™×›×•×Ÿ</div><div class="text-xl md:text-3xl font-black text-red-500" id="highRiskDisplay">0</div></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pb-4">
                    <div class="bg-white p-4 md:p-6 rounded-2xl shadow-sm border border-gray-100 flex flex-col h-64 md:h-80"><h4 class="font-bold text-gray-700 mb-2 text-xs md:text-sm">×ª×§×¦×™×‘</h4><div class="flex-1 relative w-full h-full"><canvas id="budgetChart"></canvas></div></div>
                    <div class="bg-white p-4 md:p-6 rounded-2xl shadow-sm border border-gray-100 flex flex-col h-64 md:h-80"><h4 class="font-bold text-gray-700 mb-2 text-xs md:text-sm">×¢×•××¡ ×¢×•×‘×“×™×</h4><div class="flex-1 relative w-full h-full"><canvas id="workloadChart"></canvas></div></div>
                    <div class="bg-white p-4 md:p-6 rounded-2xl shadow-sm border border-gray-100 flex flex-col h-64 md:h-80"><h4 class="font-bold text-gray-700 mb-2 text-xs md:text-sm">×¡×˜×˜×•×¡</h4><div class="flex-1 relative w-full h-full"><canvas id="statusChart"></canvas></div></div>
                    <div class="bg-white p-4 md:p-6 rounded-2xl shadow-sm border border-gray-100 flex flex-col h-64 md:h-80"><h4 class="font-bold text-gray-700 mb-2 text-xs md:text-sm">×¤×¨×•×™×§×˜×™× ××•×‘×™×œ×™×</h4><div class="flex-1 relative w-full h-full"><canvas id="topProjectsChart"></canvas></div></div>
                </div>
                <div class="bg-white p-4 md:p-6 rounded-2xl shadow-sm border border-gray-100 flex flex-col h-72">
                    <h4 class="font-bold text-gray-700 mb-2 text-xs md:text-sm flex items-center gap-2"><i class="fas fa-chart-line text-blue-500"></i> ×ª×—×–×™×ª ×¢×•××¡ ××©×™××•×ª ×©× ×ª×™</h4>
                    <div class="flex-1 relative w-full h-full"><canvas id="trendChart"></canvas></div>
                </div>
            </div>
        </div>
    </div>

    <div id="fullProjectModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-40 p-0 md:p-4 backdrop-blur-sm">
        <div class="bg-white rounded-none md:rounded-2xl w-full max-w-6xl h-full md:h-[85vh] flex flex-col shadow-2xl overflow-hidden animate-modal">
            <div class="px-4 py-3 md:px-8 md:py-5 border-b border-gray-100 flex justify-between items-center bg-white flex-shrink-0">
                <div class="w-2/3"><h2 id="modalProjectTitle" class="text-lg md:text-2xl font-bold text-gray-800 truncate"></h2><div class="flex items-center gap-3 mt-1 text-[10px] md:text-sm text-gray-500" id="modalProjectSub"></div></div>
                <div class="flex gap-2">
                    <button onclick="saveFullProject()" class="bg-blue-600 text-white p-2 md:px-6 md:py-2 rounded-xl text-xs font-bold shadow-md"><i class="fas fa-save md:hidden"></i><span class="hidden md:inline"> ×©××•×¨</span></button>
                    <button onclick="closeFullModal()" class="text-gray-400 bg-gray-50 p-2 rounded-lg"><i class="fas fa-times text-lg"></i></button>
                </div>
            </div>
            <div class="flex border-b border-gray-100 px-4 bg-white gap-2 flex-shrink-0 overflow-x-auto hide-scrollbar">
                <button onclick="switchTab('overview')" id="tab-overview" class="tab-btn active"><i class="far fa-eye ml-1"></i> ×¡×§×™×¨×”</button>
                <button onclick="switchTab('kanban')" id="tab-kanban" class="tab-btn"><i class="fas fa-tasks ml-1"></i> × ×™×”×•×œ×™</button>
                <button onclick="switchTab('timeline')" id="tab-timeline" class="tab-btn"><i class="fas fa-stream ml-1"></i> ×¦×™×¨ ×–××Ÿ</button>
                <button onclick="switchTab('activity')" id="tab-activity" class="tab-btn"><i class="far fa-comments ml-1"></i> ×¤×¢×™×œ×•×ª</button>
                <button onclick="deleteCurrentProject()" class="tab-btn text-red-500 md:hidden"><i class="fas fa-trash"></i></button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-4 md:p-6 bg-gray-50 custom-scrollbar relative">
                <div id="content-overview" class="tab-content active gap-4 md:gap-6">
                    <div class="bg-white p-4 rounded-2xl border border-gray-200 shadow-sm">
                        <h3 class="font-bold text-gray-800 text-base mb-4 pb-2 border-b border-gray-100">×¢×¨×™×›×ª ×¤×¨×˜×™×</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label class="block text-xs font-bold text-gray-500 mb-1">×©×</label><input type="text" id="editName" onchange="syncData()" class="w-full border border-gray-200 rounded-xl p-2.5 text-sm outline-none font-bold text-gray-700"></div>
                            <div class="grid grid-cols-2 gap-2">
                                <div><label class="block text-xs font-bold text-gray-500 mb-1">×”×ª×—×œ×”</label><input type="date" id="editStartDate" onchange="syncData()" class="w-full border border-gray-200 rounded-xl p-2.5 text-xs outline-none"></div>
                                <div><label class="block text-xs font-bold text-gray-500 mb-1">×¡×™×•×</label><input type="date" id="editEndDate" onchange="syncData()" class="w-full border border-gray-200 rounded-xl p-2.5 text-xs outline-none"></div>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div><label class="block text-xs font-bold text-gray-500 mb-1">×¡×˜×˜×•×¡</label><select id="editStatus" onchange="syncData()" class="w-full border border-gray-200 rounded-xl p-2.5 text-sm bg-white outline-none"></select></div>
                                <div><label class="block text-xs font-bold text-gray-500 mb-1">××—×¨××™</label><select id="editOwner" onchange="syncData()" class="w-full border border-gray-200 rounded-xl p-2.5 text-sm bg-white outline-none"></select></div>
                            </div>
                            <div><label class="block text-xs font-bold text-gray-500 mb-1">×ª×§×¦×™×‘ (â‚ª)</label><input type="number" id="editCost" onchange="syncData()" class="w-full border border-gray-200 rounded-xl p-2.5 text-sm outline-none"></div>
                            <div class="md:col-span-2"><label class="block text-xs font-bold text-gray-500 mb-1">×ª×™××•×¨</label><textarea id="editDesc" onchange="syncData()" class="w-full border border-gray-200 rounded-xl p-3 text-sm outline-none resize-none" rows="2"></textarea></div>
                            <div class="md:col-span-2"><label class="block text-xs font-bold text-gray-500 mb-2">×¦×•×•×ª</label><div id="viewTeamList" class="flex flex-wrap gap-2"></div></div>
                        </div>
                    </div>
                </div>
                
                <div id="content-kanban" class="tab-content gap-4">
                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                        <div class="flex flex-col gap-3">
                            <input id="newTaskInput" type="text" class="w-full bg-white border border-gray-200 rounded-xl px-4 py-3 text-sm outline-none" placeholder="××©×™××” ×—×“×©×”..." onkeypress="if(event.key === 'Enter') addTask()">
                            <div class="flex gap-2">
                                <input type="date" id="newTaskDate" class="flex-1 bg-white border border-gray-200 rounded-xl px-3 py-2 text-sm outline-none">
                                <button onclick="addTask()" class="bg-blue-100 text-blue-600 px-6 py-2 rounded-xl text-sm font-bold">×”×•×¡×£</button>
                            </div>
                        </div>
                    </div>
                    <div id="tasksList" class="space-y-3 flex-grow overflow-y-auto pb-4"></div>
                </div>

                <div id="content-timeline" class="tab-content">
                    <div class="bg-white p-6 rounded-2xl border border-gray-200 shadow-sm overflow-hidden">
                        <h3 class="font-bold text-gray-800 mb-4 text-sm md:text-base flex items-center gap-2">
                            <i class="fas fa-stream text-blue-500"></i> ×¤×¨×™×¡×ª ××©×™××•×ª ×¢×œ ×¦×™×¨ ×”×–××Ÿ
                        </h3>
                        <div id="projectGanttContainer" class="w-full"></div>
                    </div>
                </div>
                
                <div id="content-activity" class="tab-content gap-4">
                    <div class="bg-white p-4 rounded-2xl border border-gray-200 shadow-sm flex-shrink-0">
                        <textarea id="newNoteText" class="w-full bg-gray-50 border-none rounded-xl p-3 text-sm mb-2 outline-none" rows="2" placeholder="×›×ª×•×‘ ×”×¢×¨×”..."></textarea>
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-2">
                                <input type="file" id="fileInput" class="hidden" onchange="handleFileSelect(this)">
                                <button onclick="document.getElementById('fileInput').click()" class="text-blue-600 bg-blue-50 px-3 py-1.5 rounded-lg text-xs font-bold"><i class="fas fa-paperclip"></i> ×¦×¨×£</button>
                                <span id="fileNameDisplay" class="text-xs text-gray-500 truncate max-w-[100px] hidden"></span>
                            </div>
                            <button onclick="addActivityNote()" class="bg-blue-600 text-white px-5 py-1.5 rounded-lg text-sm font-bold">×©×œ×—</button>
                        </div>
                    </div>
                    <div id="activityFeed" class="space-y-3 flex-grow overflow-y-auto"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="newProjectModal" class="fixed inset-0 bg-gray-900 bg-opacity-70 hidden items-center justify-center z-50 p-0 md:p-4 backdrop-blur-sm">
        <div class="bg-white rounded-none md:rounded-2xl w-full max-w-2xl h-full md:max-h-[90vh] flex flex-col shadow-2xl animate-modal">
            <div class="p-4 md:p-6 border-b border-gray-100 flex justify-between items-center bg-white"><h3 class="text-lg md:text-xl font-bold text-gray-800">×¤×¨×•×™×§×˜ ×—×“×©</h3><button onclick="document.getElementById('newProjectModal').classList.add('hidden')" class="bg-gray-50 hover:bg-gray-100 p-2 rounded-lg transition"><i class="fas fa-times text-gray-500"></i></button></div>
            <div class="p-6 overflow-y-auto space-y-6 custom-scrollbar flex-1">
                <div><label class="block text-xs font-bold text-gray-500 mb-1.5 uppercase">×©× ×”×¤×¨×•×™×§×˜ *</label><input id="npName" class="w-full border border-gray-200 rounded-xl p-3 outline-none"></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-xs font-bold text-gray-500 mb-1.5 uppercase">××ª×¨</label><select id="npSite" class="w-full border border-gray-200 rounded-xl p-3 bg-white outline-none"></select></div>
                    <div><label class="block text-xs font-bold text-gray-500 mb-1.5 uppercase">××—×œ×§×”</label><select id="npDept" class="w-full border border-gray-200 rounded-xl p-3 bg-white outline-none"></select></div>
                    <div><label class="block text-xs font-bold text-gray-500 mb-1.5 uppercase">××—×¨××™ *</label><select id="npOwner" class="w-full border border-gray-200 rounded-xl p-3 bg-white outline-none"></select></div>
                    <div><label class="block text-xs font-bold text-gray-500 mb-1.5 uppercase">×¢×“×™×¤×•×ª</label><select id="npPriority" class="w-full border border-gray-200 rounded-xl p-3 bg-white outline-none"><option value="low">× ××•×›×”</option><option value="medium" selected>×‘×™× ×•× ×™×ª</option><option value="high">×’×‘×•×”×”</option></select></div>
                    <div><label class="block text-xs font-bold text-gray-500 mb-1.5 uppercase">×”×ª×—×œ×” *</label><input type="date" id="npStart" class="w-full border border-gray-200 rounded-xl p-3 outline-none"></div>
                    <div><label class="block text-xs font-bold text-gray-500 mb-1.5 uppercase">×¡×™×•×</label><input type="date" id="npEnd" class="w-full border border-gray-200 rounded-xl p-3 outline-none"></div>
                    <div><label class="block text-xs font-bold text-gray-500 mb-1.5 uppercase">×¢×œ×•×ª</label><input type="number" id="npCost" class="w-full border border-gray-200 rounded-xl p-3 outline-none" placeholder="0"></div>
                </div>
                <div><label class="block text-xs font-bold text-gray-500 mb-2 uppercase">×©×•×ª×¤×™×</label><div id="npTeam" class="grid grid-cols-3 md:grid-cols-4 gap-3 bg-gray-50 p-4 rounded-xl border border-gray-100"></div></div>
            </div>
            <div class="p-4 md:p-6 border-t bg-gray-50 flex justify-end gap-3"><button onclick="document.getElementById('newProjectModal').classList.add('hidden')" class="px-6 py-2.5 border rounded-xl hover:bg-gray-100 font-medium">×‘×™×˜×•×œ</button><button onclick="createNewProject()" class="px-8 py-2.5 bg-blue-600 text-white rounded-xl font-bold shadow-md hover:bg-blue-700">×¦×•×¨</button></div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyB7U5xw_FMThsmM2hNMRnkdMYnD2cutH2s",
            authDomain: "project-manager-4702c.firebaseapp.com",
            databaseURL: "https://project-manager-4702c-default-rtdb.firebaseio.com",
            projectId: "project-manager-4702c",
            storageBucket: "project-manager-4702c.firebasestorage.app",
            messagingSenderId: "941533299304",
            appId: "1:941533299304:web:92f8940e93a96b1f8b71dd",
            measurementId: "G-NZHPST88NC"
        };

        (function() { emailjs.init("lVJCS9f5i8YqFTNyK"); })();

        const ADMIN_EMAILS = ['hagay1989@gmail.com','hagay@herzliya-marina.co.il','ronit@herzliya-marina.co.il']; 
        const TEAM_DIRECTORY = { '×•×œ×¨×™': 'valery@herzliya-marina.co.il', '×—×’×™×ª': 'hagits@herzliya-marina.co.il', '×¨×•× ×™×ª': 'ronit@herzliya-marina.co.il', '×™×¤×™×ª': 'office@herzliya-marina.co.il', '×–×× ×”': 'zana@herzliya-marina.co.il', '×—×’×™': 'hagay@herzliya-marina.co.il', '×¢×™×¨×': 'iralif@herzliya-marina.co.il', '×™×¨×“×Ÿ': 'yarden.ak@herzliya-marina.co.il', '××™×›××œ×”': 'michaela@herzliya-marina.co.il', '××¢×™×™×Ÿ': 'maayans@herzliya-marina.co.il', '××œ×›×¡': 'alexf@herzliya-marina.co.il' };
        const SITES = ['××‘× ×” ×× ×”×œ×”', '××‘× ×” ××¡×¤× ×”', '×—×•×£ ×”×™×', '×©×•×‘×¨ ×’×œ×™×', '××™×¨×•×¢×™×', '×¨×¦×™×¤×™×'];
        const DEPARTMENTS = ['××—×–×§×”', '× ×›×¡×™×', '××¢×’× ×”', '××¡×¤× ×”', '×”× ×”×œ×”', '×”× ×”×œ×ª ×—×©×‘×•× ×•×ª', '××™×¨×•×¢×™×', '×©×™×¨×•×ª ×œ×§×•×—×•×ª'];
        const STATUSES = { 'planned': {label:'××ª×•×›× ×Ÿ', color:'bg-gray-100 text-gray-600', icon:'fa-calendar'}, 'in-progress': {label:'×‘×‘×™×¦×•×¢', color:'bg-blue-100 text-blue-600', icon:'fa-spinner'}, 'blocked': {label:'××‘×Ÿ ×“×¨×š', color:'bg-purple-100 text-purple-600', icon:'fa-flag'}, 'done': {label:'×”×•×©×œ×', color:'bg-green-100 text-green-600', icon:'fa-check'} };

        function safeGet(id) { return document.getElementById(id); }
        function safeVal(id, val) { const el = document.getElementById(id); if(el) { if(val!==undefined) el.value = val; return el.value; } return ''; }
        function safeText(id, text) { const el = document.getElementById(id); if(el) el.textContent = text; }
        function safeHTML(id, html) { const el = document.getElementById(id); if(el) el.innerHTML = html; }
        function safeAddClass(id, cls) { const el = document.getElementById(id); if(el) el.classList.add(cls); }
        function safeRemoveClass(id, cls) { const el = document.getElementById(id); if(el) el.classList.remove(cls); }

        document.addEventListener('DOMContentLoaded', () => { try { fillDropdowns(); } catch(e) { console.error("Error init lists:", e); } });

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentUser = null;
        let projectsData = [];
        let currentView = 'list';
        let currentEditingProject = null;
        let selectedFile = null;
        let analyticsCharts = {};
        let isLoginMode = true;

        // AUTH
        function toggleAuthMode() {
            isLoginMode = !isLoginMode;
            const title = safeGet('authTitle'); const btn = safeGet('authBtn');
            const toggleText = safeGet('authToggleText'); const toggleLink = safeGet('authToggleLink');
            const errorDiv = safeGet('authError');
            if(errorDiv) errorDiv.classList.add('hidden');
            if (isLoginMode) { title.innerText = "×›× ×™×¡×” ×œ××¢×¨×›×ª"; btn.innerText = "×”×ª×—×‘×¨"; toggleText.innerText = "××™×Ÿ ×œ×š ×—×©×‘×•×Ÿ? "; toggleLink.innerText = "×”×™×¨×©× ×›××Ÿ"; }
            else { title.innerText = "×”×¨×©××” ×œ××¢×¨×›×ª"; btn.innerText = "×”×™×¨×©×"; toggleText.innerText = "×™×© ×œ×š ×›×‘×¨ ×—×©×‘×•×Ÿ? "; toggleLink.innerText = "×”×ª×—×‘×¨ ×›××Ÿ"; }
        }
        function handleAuthAction() {
            const e = safeVal('emailInput').toLowerCase().trim(); 
            const p = safeVal('passInput');
            if(!e || !p) { alert('× × ×œ××œ× ××™××™×™×œ ×•×¡×™×¡××”'); return; }
            const allowedEmails = [...ADMIN_EMAILS, ...Object.values(TEAM_DIRECTORY)].map(email => email.toLowerCase().trim());
            if (!allowedEmails.includes(e)) { safeText('authError', '×’×™×©×” × ×“×—×ª×”: ×”××™×™×œ ××™× ×• ××•×¤×™×¢ ×‘×¨×©×™××ª ×”××•×¨×©×™×.'); safeRemoveClass('authError', 'hidden'); return; }
            const action = isLoginMode ? auth.signInWithEmailAndPassword(e, p) : auth.createUserWithEmailAndPassword(e, p);
            action.then(() => { safeGet('emailInput').value = ''; safeGet('passInput').value = ''; safeAddClass('authError', 'hidden'); }).catch(err => { let msg = err.message; safeText('authError', msg); safeRemoveClass('authError', 'hidden'); });
        }

        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                safeAddClass('loginScreen', 'hidden'); safeRemoveClass('app', 'hidden'); safeAddClass('app', 'flex');
                safeText('userEmailDisplay', user.email);
                const isAdmin = ADMIN_EMAILS.includes(user.email);
                if(isAdmin) safeRemoveClass('adminBadge', 'hidden'); else safeAddClass('adminBadge', 'hidden');
                initApp();
            } else { safeRemoveClass('loginScreen', 'hidden'); safeAddClass('app', 'hidden'); safeRemoveClass('app', 'flex'); }
        });

        // APP LOGIC
        function initApp() {
            db.collection('projects').onSnapshot(snap => {
                const allProjects = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const userEmail = currentUser.email;
                const isAdmin = ADMIN_EMAILS.includes(userEmail);
                projectsData = allProjects.filter(p => { if (isAdmin) return true; if (p.userId === currentUser.uid) return true; if (p.team && Array.isArray(p.team) && p.team.includes(userEmail)) return true; return false; });
                projectsData.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                renderProjects();
                if (currentEditingProject) { const updated = projectsData.find(p => p.id === currentEditingProject.id); if(updated) { currentEditingProject = updated; refreshModalUI(); } }
            });
        }

        function fillDropdowns() {
            const populate = (id, list) => { const el = document.getElementById(id); if(el) el.innerHTML = list.map(i => `<option value="${i}">${i}</option>`).join(''); };
            const names = Object.keys(TEAM_DIRECTORY);
            populate('npSite', SITES); populate('npDept', DEPARTMENTS); populate('npOwner', names);
            const editOwner = document.getElementById('editOwner'); if(editOwner) editOwner.innerHTML = names.map(m => `<option value="${m}">${m}</option>`).join('');
            const editStatus = document.getElementById('editStatus'); if(editStatus) editStatus.innerHTML = Object.keys(STATUSES).map(k => `<option value="${k}">${STATUSES[k].label}</option>`).join('');
            const teamContainer = document.getElementById('npTeam'); 
            if(teamContainer) { teamContainer.innerHTML = names.map(name => { const email = TEAM_DIRECTORY[name]; return `<label class="flex items-center gap-2 cursor-pointer bg-white p-2 rounded-lg border hover:bg-blue-50 transition"><input type="checkbox" value="${email}" class="rounded text-blue-600 w-4 h-4"><span class="text-xs font-bold text-gray-700">${name}</span></label>`; }).join(''); }
            const depFilter = document.getElementById('filterDept'); if(depFilter) { depFilter.innerHTML = '<option value="all">×›×œ ×”××—×œ×§×•×ª</option>'; DEPARTMENTS.forEach(d => depFilter.innerHTML += `<option value="${d}">${d}</option>`); }
            const statFilter = document.getElementById('filterStatus'); if(statFilter) { statFilter.innerHTML = '<option value="all">×›×œ ×”×¡×˜×˜×•×¡×™×</option>'; Object.keys(STATUSES).forEach(k => statFilter.innerHTML += `<option value="${k}">${STATUSES[k].label}</option>`); }
            const ganttDept = document.getElementById('ganttDeptFilter'); if(ganttDept) { ganttDept.innerHTML = '<option value="all">ğŸ¢ ×›×œ ×”××—×œ×§×•×ª</option>'; DEPARTMENTS.forEach(d => ganttDept.innerHTML += `<option value="${d}">${d}</option>`); }
        }

        function renderProjects() {
            const container = safeGet('mainContent'); if(!container) return;
            const dept = safeVal('filterDept'); const status = safeVal('filterStatus');
            const filtered = projectsData.filter(p => { if(dept !== 'all' && p.department !== dept) return false; if(status !== 'all' && p.status !== status) return false; return true; });
            if (currentView === 'list') { updateViewButtons('list'); container.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">${filtered.map(p => createProjectCardHTML(p)).join('')}</div>`; } 
            else { updateViewButtons('kanban'); const cols = Object.keys(STATUSES).map(k => { const items = filtered.filter(p => p.status === k); return `<div class="bg-gray-50 p-4 rounded-2xl min-w-[280px] h-fit border border-gray-200"><h3 class="font-bold text-gray-700 mb-4 flex justify-between items-center px-1"><span class="flex items-center gap-2"><i class="fas ${STATUSES[k].icon} text-gray-400"></i> ${STATUSES[k].label}</span><span class="bg-white text-gray-600 text-xs px-2.5 py-1 rounded-lg shadow-sm border border-gray-100 font-mono">${items.length}</span></h3><div class="space-y-3">${items.map(p => createProjectCardHTML(p)).join('')}</div></div>`; }).join(''); container.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-4 gap-6 overflow-x-auto pb-4">${cols}</div>`; }
        }

        function createProjectCardHTML(p) {
            const s = STATUSES[p.status] || STATUSES['planned'];
            const tasks = p.tasks || [];
            const done = tasks.filter(t => t.done).length;
            const progress = tasks.length > 0 ? Math.round((done / tasks.length) * 100) : 0;
            let risk = ''; if(p.status === 'blocked') risk = `<div class="mt-4 pt-3 border-t border-gray-50 text-red-600 bg-red-50 p-2 rounded-lg text-xs font-bold flex items-center gap-2"><i class="fas fa-exclamation-triangle"></i> ×—×¡×•× / ×¡×™×›×•×Ÿ ×’×‘×•×”</div>`; else if (progress < 50 && p.endDate && new Date(p.endDate) < new Date()) risk = `<div class="mt-4 pt-3 border-t border-gray-50 text-yellow-600 bg-yellow-50 p-2 rounded-lg text-xs font-bold flex items-center gap-2"><i class="fas fa-bolt"></i> ×¡×™×›×•×Ÿ ×‘×™× ×•× ×™</div>`;
            const teamCount = p.team ? p.team.length : 0;
            return `<div onclick="openFullProject('${p.id}')" class="bg-white border border-gray-100 rounded-2xl p-6 hover:shadow-xl transition-all cursor-pointer hover:-translate-y-1 relative group"><div class="flex justify-between items-start mb-4"><div><h3 class="font-bold text-gray-800 text-lg mb-1 group-hover:text-blue-600 transition">${p.name}</h3><p class="text-xs text-gray-500 flex items-center gap-1.5"><i class="fas fa-map-marker-alt text-gray-300"></i> ${p.site}</p></div><span class="px-3 py-1 rounded-lg text-xs font-bold ${s.color} border border-black/5 shadow-sm">${s.label}</span></div><div class="space-y-3 mb-5"><div class="flex items-center text-xs text-gray-600 gap-2 bg-gray-50 p-2 rounded-lg"><i class="fas fa-users w-4 text-center text-gray-400"></i> ${teamCount} ×©×•×ª×¤×™×</div><div class="flex items-center text-xs text-gray-600 gap-2 bg-gray-50 p-2 rounded-lg"><i class="fas fa-calendar-alt w-4 text-center text-gray-400"></i> <span dir="ltr">${p.startDate || '?'} -> ${p.endDate || '?'}</span></div></div><div class="mb-2"><div class="flex justify-between text-xs mb-1.5"><span class="text-gray-500 font-medium">×”×ª×§×“××•×ª ×‘×™×¦×•×¢</span><span class="font-bold text-blue-600">${progress}%</span></div><div class="w-full bg-gray-100 rounded-full h-2 overflow-hidden"><div class="h-full bg-blue-600 rounded-full shadow-sm" style="width: ${progress}%"></div></div></div>${risk}</div>`;
        }

        function openFullProject(id) {
            currentEditingProject = projectsData.find(p => p.id === id); if (!currentEditingProject) return;
            safeText('modalProjectTitle', currentEditingProject.name);
            safeHTML('modalProjectSub', `<i class="fas fa-building text-gray-300"></i> ${currentEditingProject.site} <span class="mx-2 text-gray-200">|</span> <i class="fas fa-briefcase text-gray-300"></i> ${currentEditingProject.department}`);
            safeVal('editName', currentEditingProject.name); safeVal('editCost', currentEditingProject.estimatedCost); safeVal('editStatus', currentEditingProject.status); safeVal('editOwner', currentEditingProject.owner); safeVal('editStartDate', currentEditingProject.startDate || ''); safeVal('editEndDate', currentEditingProject.endDate || ''); safeVal('editDesc', currentEditingProject.objective || '');
            refreshModalUI(); switchTab('overview'); safeRemoveClass('fullProjectModal', 'hidden'); safeAddClass('fullProjectModal', 'flex');
        }

        function refreshModalUI() {
            const tasks = currentEditingProject.tasks || [];
            const done = tasks.filter(t => t.done).length;
            const progress = tasks.length > 0 ? Math.round((done / tasks.length) * 100) : 0;
            safeText('statProgress', progress + '%'); const pBar = safeGet('statProgressBar'); if(pBar) pBar.style.width = progress + '%';
            safeText('viewStartDate', currentEditingProject.startDate || '-'); safeText('viewEndDate', currentEditingProject.endDate || '-');
            let risk = '× ××•×›×”'; if (currentEditingProject.status === 'blocked') risk = '×’×‘×•×”×”'; safeText('statRisk', risk);
            const teamContainer = safeGet('viewTeamList');
            if (teamContainer) {
                const team = currentEditingProject.team || [];
                if (team.length === 0) { teamContainer.innerHTML = '<span class="text-gray-400 text-sm">××™×Ÿ ×©×•×ª×¤×™× × ×•×¡×¤×™×</span>'; } 
                else {
                    const hebrewMapping = { 'alex': '××œ×›×¡', 'alexf': '××œ×›×¡', 'hagay': '×—×’×™', 'valery': '×•×œ×¨×™', 'ronit': '×¨×•× ×™×ª', 'hagits': '×—×’×™×ª', 'hagit': '×—×’×™×ª', 'maayans': '××¢×™×™×Ÿ', 'maayan': '××¢×™×™×Ÿ', 'yarden': '×™×¨×“×Ÿ', 'michaela': '××™×›××œ×”', 'iralif': '×¢×™×¨×', 'ira': '×¢×™×¨×', 'zana': '×–×× ×”', 'office': '×™×¤×™×ª', 'yafit': '×™×¤×™×ª' };
                    const names = team.map(email => { const foundName = Object.keys(TEAM_DIRECTORY).find(key => TEAM_DIRECTORY[key].toLowerCase().trim() === email.toLowerCase().trim()); if (foundName) return foundName; const shortName = email.split('@')[0].toLowerCase(); if (hebrewMapping[shortName]) return hebrewMapping[shortName]; return shortName; });
                    teamContainer.innerHTML = names.map(n => `<span class="bg-indigo-50 text-indigo-700 border border-indigo-100 px-3 py-1 rounded-full text-xs font-bold shadow-sm">${n}</span>`).join('');
                }
            }
            const activeTab = document.querySelector('.tab-content.active');
            if (activeTab && activeTab.id === 'content-kanban') renderTasksList();
            if (activeTab && activeTab.id === 'content-activity') renderActivityFeed();
            if (activeTab && activeTab.id === 'content-timeline') renderProjectGanttChart(); 
        }

        function switchTab(name) { document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); safeAddClass(`tab-${name}`, 'active'); document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active')); safeAddClass(`content-${name}`, 'active'); refreshModalUI(); }
        function syncData() { currentEditingProject.name = safeVal('editName'); currentEditingProject.estimatedCost = safeVal('editCost'); safeText('modalProjectTitle', currentEditingProject.name); currentEditingProject.startDate = safeVal('editStartDate'); currentEditingProject.endDate = safeVal('editEndDate'); currentEditingProject.status = safeVal('editStatus'); currentEditingProject.owner = safeVal('editOwner'); currentEditingProject.objective = safeVal('editDesc'); refreshModalUI(); }

        // --- GANTT CALENDAR LOGIC (MAIN) ---
        let ganttCurrentDate = new Date();
        let expandedProjects = new Set(); 
        function openGanttModal() { ganttCurrentDate = new Date(); renderGanttCalendar(); safeRemoveClass('ganttModal', 'hidden'); safeAddClass('ganttModal', 'flex'); }
        function changeGanttMonth(offset) { ganttCurrentDate.setMonth(ganttCurrentDate.getMonth() + offset); renderGanttCalendar(); }
        function toggleGanttExpand(projectId) { if (expandedProjects.has(projectId)) { expandedProjects.delete(projectId); } else { expandedProjects.add(projectId); } renderGanttCalendar(); }

        function renderGanttCalendar() {
            const gridContainer = document.getElementById('calendarGrid'); if(!gridContainer) return;
            gridContainer.innerHTML = '';
            const year = ganttCurrentDate.getFullYear(); const month = ganttCurrentDate.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate(); const today = new Date(); today.setHours(0,0,0,0);
            const monthNames = ["×™× ×•××¨", "×¤×‘×¨×•××¨", "××¨×¥", "××¤×¨×™×œ", "×××™", "×™×•× ×™", "×™×•×œ×™", "××•×’×•×¡×˜", "×¡×¤×˜××‘×¨", "××•×§×˜×•×‘×¨", "× ×•×‘××‘×¨", "×“×¦××‘×¨"];
            document.getElementById('ganttMonthLabel').textContent = `${monthNames[month]} ${year}`;
            const deptFilter = document.getElementById('ganttDeptFilter') ? document.getElementById('ganttDeptFilter').value : 'all';
            const relevantProjects = projectsData.filter(p => {
                if(deptFilter !== 'all' && p.department !== deptFilter) return false;
                if(!p.startDate || !p.endDate) return false;
                const pStart = new Date(p.startDate); const pEnd = new Date(p.endDate);
                const monthStart = new Date(year, month, 1); const monthEnd = new Date(year, month, daysInMonth);
                return (pStart <= monthEnd && pEnd >= monthStart);
            });

            const scrollArea = document.createElement('div'); scrollArea.className = 'timeline-scroll-area custom-scrollbar';
            let headerHTML = `<div class="timeline-header"><div class="sticky-col border-b">×¤×¨×•×™×§×˜</div>`; 
            for(let i = 1; i <= daysInMonth; i++) {
                const dateObj = new Date(year, month, i); const isWeekend = dateObj.getDay() === 5 || dateObj.getDay() === 6; const bgClass = isWeekend ? 'bg-gray-100' : '';
                headerHTML += `<div class="timeline-header-cell ${bgClass}">${i}</div>`;
            }
            headerHTML += `</div>`;

            let bodyHTML = `<div class="timeline-body"><div class="timeline-track" style="right: 160px; left:0;"></div>`; 
            if (relevantProjects.length === 0) { bodyHTML += `<div class="p-10 text-center text-gray-400">××™×Ÿ ×¤×¨×•×™×§×˜×™× ×œ×—×•×“×© ×–×”</div>`; } 
            else {
                relevantProjects.forEach(p => {
                    const pStart = new Date(p.startDate); const pEnd = new Date(p.endDate);
                    const viewStart = new Date(year, month, 1); const viewEnd = new Date(year, month, daysInMonth);
                    const actualStart = pStart < viewStart ? viewStart : pStart; const actualEnd = pEnd > viewEnd ? viewEnd : pEnd;
                    const startDay = actualStart.getDate(); const endDay = actualEnd.getDate();
                    const durationDays = (endDay - startDay) + 1;
                    const dayWidth = 41; const leftPos = (startDay - 1) * dayWidth; const widthPx = durationDays * dayWidth;
                    let barColor = 'linear-gradient(90deg, #3b82f6 0%, #2563eb 100%)'; 
                    if(p.status === 'blocked') barColor = 'linear-gradient(90deg, #ef4444 0%, #dc2626 100%)'; 
                    if(p.status === 'done') barColor = 'linear-gradient(90deg, #10b981 0%, #059669 100%)'; 
                    if(p.status === 'planned') barColor = 'linear-gradient(90deg, #9ca3af 0%, #6b7280 100%)'; 
                    const isExpanded = expandedProjects.has(p.id); const expandIcon = isExpanded ? '<i class="fas fa-minus"></i>' : '<i class="fas fa-plus"></i>';
                    let cellsHTML = ''; for(let i=1; i<=daysInMonth; i++) { const d = new Date(year, month, i); const isW = d.getDay()===5 || d.getDay()===6; cellsHTML += `<div style="width:40px; border-right:1px solid #f3f4f6; flex-shrink:0; background:${isW?'#f9fafb':'transparent'}"></div>`; }

                    bodyHTML += `<div class="timeline-row"><div class="sticky-col"><div class="expand-btn" onclick="toggleGanttExpand('${p.id}')">${expandIcon}</div><span class="truncate pr-2 font-bold text-gray-700" title="${p.name}">${p.name}</span></div><div style="display:flex; position:relative; flex:1;">${cellsHTML}<div class="timeline-bar" onclick="openFullProject('${p.id}')" style="left: ${leftPos}px; width: ${widthPx}px; background: ${barColor};">${p.name}</div></div></div>`;

                    if (isExpanded && p.tasks && p.tasks.length > 0) {
                        p.tasks.forEach(task => {
                            if(task.dueDate) {
                                const tDate = new Date(task.dueDate);
                                if(tDate.getMonth() === month && tDate.getFullYear() === year) {
                                    const tDay = tDate.getDate(); const tLeft = (tDay - 1) * dayWidth + (dayWidth/2);
                                    let stoneColor = '#facc15'; if(task.done) stoneColor = '#22c55e'; else if(tDate < today) stoneColor = '#ef4444';
                                    bodyHTML += `<div class="timeline-row task-row"><div class="sticky-col bg-gray-50"><span class="truncate pl-4 text-gray-500" title="${task.name}"><i class="fas fa-level-up-alt rotate-90 ml-2"></i> ${task.name}</span></div><div style="display:flex; position:relative; flex:1;">${cellsHTML}<div class="gantt-milestone" style="left:${tLeft}px; background-color:${stoneColor};" title="${task.name}"></div></div></div>`;
                                }
                            }
                        });
                    }
                });
            }
            bodyHTML += `</div>`; scrollArea.innerHTML = headerHTML + bodyHTML; gridContainer.appendChild(scrollArea);
        }

        function downloadGanttImage() {
            const element = document.querySelector('#ganttModal > div'); if (!element) return;
            const stickies = document.querySelectorAll('.sticky-col'); stickies.forEach(el => { el.style.position = 'static'; el.style.border = '1px solid #eee'; });
            const scrollArea = document.querySelector('.timeline-scroll-area'); const originalOverflow = scrollArea.style.overflow; scrollArea.style.overflow = 'visible'; 
            html2canvas(element, { scale: 2, backgroundColor: "#ffffff", useCORS: true }).then(canvas => { stickies.forEach(el => el.style.position = ''); scrollArea.style.overflow = originalOverflow; const link = document.createElement('a'); link.download = `Project-Gantt-${new Date().toLocaleDateString('he-IL').replace(/\./g, '-')}.png`; link.href = canvas.toDataURL("image/png"); link.click(); }).catch(err => { console.error(err); alert("×©×’×™××” ×‘×¦×™×œ×•×"); });
        }

        // --- FIXED INTERNAL TIMELINE FUNCTION ---
        function renderProjectGanttChart() {
            const container = safeGet('projectGanttContainer'); // <--- Fixed ID here!
            if(!container) return;
            const p = currentEditingProject;
            if(!p.startDate || !p.endDate) { container.innerHTML = '<div class="text-center py-10 text-gray-400 bg-gray-50 rounded-xl border border-dashed flex flex-col items-center gap-2"><i class="far fa-calendar-times text-2xl"></i><span>× × ×œ×”×’×“×™×¨ ×ª××¨×™×›×™ ×”×ª×—×œ×” ×•×¡×™×•×</span></div>'; return; }

            const start = new Date(p.startDate);
            const end = new Date(p.endDate);
            const totalTime = end - start;
            const today = new Date();
            const sStr = start.toLocaleDateString('he-IL');
            const eStr = end.toLocaleDateString('he-IL');
            
            let milestonesHTML = '';
            if (p.tasks && p.tasks.length > 0) {
                p.tasks.forEach(task => {
                    if (task.dueDate) {
                        const tDate = new Date(task.dueDate);
                        let percent = 0;
                        if (totalTime > 0) { percent = ((tDate - start) / totalTime) * 100; }
                        if (percent < 0) percent = 0; if (percent > 100) percent = 100;
                        let color = '#facc15'; if (task.done) color = '#22c55e'; else if (tDate < today) color = '#ef4444';
                        milestonesHTML += `<div class="mini-milestone" style="left: ${percent}%; background-color: ${color};" title="${task.name} (${tDate.toLocaleDateString('he-IL')})"></div>`;
                    }
                });
            }

            let progressPercent = 0;
            if (today > start) { progressPercent = ((today - start) / totalTime) * 100; if (progressPercent > 100) progressPercent = 100; }
            if (totalTime <= 0) progressPercent = 0;

            container.innerHTML = `
                <div class="relative pt-6 pb-2 px-2">
                    <div class="flex justify-between text-xs text-gray-500 mb-2 font-mono font-bold"><span><i class="far fa-play-circle"></i> ${sStr}</span><span><i class="far fa-flag"></i> ${eStr}</span></div>
                    <div class="project-timeline-track">
                        <div class="absolute top-0 bottom-0 right-0 bg-blue-50 border-l border-blue-100" style="width: ${progressPercent}%"></div>
                        <div class="project-timeline-bar" style="width: ${p.progress || 0}%"><span class="absolute left-2 text-white text-xs drop-shadow-md">${p.progress}%</span></div>
                        ${milestonesHTML}
                    </div>
                    <div class="mt-3 flex justify-center gap-4 text-[10px] text-gray-400">
                        <span class="flex items-center gap-1"><div class="w-2 h-2 bg-green-500 transform rotate-45"></div> ×‘×•×¦×¢</span>
                        <span class="flex items-center gap-1"><div class="w-2 h-2 bg-red-500 transform rotate-45"></div> ××™×—×•×¨</span>
                        <span class="flex items-center gap-1"><div class="w-2 h-2 bg-yellow-400 transform rotate-45"></div> ×™×¢×“</span>
                    </div>
                </div>
            `;
        }

        // --- Rest of functions ---
        function renderTasksList() {
            const list = safeGet('tasksList'); if(!list) return;
            const tasks = currentEditingProject.tasks || [];
            if(tasks.length === 0) { list.innerHTML = `<div class="flex flex-col items-center justify-center h-48 text-gray-400 bg-white rounded-2xl border border-dashed border-gray-200"><i class="fas fa-clipboard-check text-4xl mb-3 opacity-20"></i><span class="text-sm">××™×Ÿ ××©×™××•×ª ×œ×‘×™×¦×•×¢.</span></div>`; return; }
            list.innerHTML = tasks.map((t, idx) => {
                let dateBadge = '';
                if(t.dueDate) {
                    const dateObj = new Date(t.dueDate); const dateStr = dateObj.toLocaleDateString('he-IL', { day: '2-digit', month: '2-digit' });
                    const isOverdue = new Date() > dateObj && !t.done;
                    const colorClass = isOverdue ? 'bg-red-50 text-red-600 border-red-100' : 'bg-gray-50 text-gray-500 border-gray-100';
                    dateBadge = `<div class="flex items-center gap-1.5 px-2 py-1 rounded-md border text-xs font-mono ${colorClass}"><i class="far fa-clock text-[10px]"></i> ${dateStr}</div>`;
                }
                return `<div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm hover:shadow-md transition-all group flex items-center justify-between"><div class="flex items-center gap-4"><div onclick="toggleTask(${idx})" class="w-6 h-6 rounded-full border-2 ${t.done ? 'bg-green-500 border-green-500' : 'border-gray-200 group-hover:border-blue-400'} flex items-center justify-center cursor-pointer transition flex-shrink-0">${t.done ? '<i class="fas fa-check text-white text-xs"></i>' : ''}</div><div><span class="${t.done ? 'line-through text-gray-400' : 'text-gray-800 font-medium'} text-sm block mb-1">${t.name}</span><div class="flex items-center gap-2"><span class="text-xs text-gray-400 flex items-center gap-1"><i class="fas fa-user-circle"></i> ${t.assignee || '×œ× ×”×•×§×¦×”'}</span></div></div></div><div class="flex items-center gap-3">${dateBadge}<button onclick="deleteTask(${idx})" class="w-8 h-8 rounded-lg flex items-center justify-center text-gray-300 hover:text-red-500 hover:bg-red-50 transition"><i class="fas fa-trash-alt"></i></button></div></div>`;
            }).join('');
        }
        function addTask() {
            const input = safeGet('newTaskInput'); const dateInput = safeGet('newTaskDate');
            if(!input || !input.value.trim()) return;
            if (!currentEditingProject.tasks) currentEditingProject.tasks = [];
            let currentUserName = '×œ× ×”×•×§×¦×”';
            if (currentUser && currentUser.email) {
                const directoryName = Object.keys(TEAM_DIRECTORY).find(key => TEAM_DIRECTORY[key].toLowerCase() === currentUser.email.toLowerCase());
                if (directoryName) { currentUserName = directoryName; } else { if (currentUser.email === 'hagay1989@gmail.com') { currentUserName = '×—×’×™'; } else { currentUserName = currentUser.email.split('@')[0]; } }
            }
            const newTask = { name: input.value.trim(), done: false, assignee: currentUserName, dueDate: dateInput.value || null };
            currentEditingProject.tasks.push(newTask); input.value = ''; dateInput.value = '';
            db.collection('projects').doc(currentEditingProject.id).update({ tasks: currentEditingProject.tasks });
            renderTasksList(); 
        }
        function toggleTask(idx) { currentEditingProject.tasks[idx].done = !currentEditingProject.tasks[idx].done; db.collection('projects').doc(currentEditingProject.id).update({ tasks: currentEditingProject.tasks }); }
        function deleteTask(idx) { const newTasks = [...currentEditingProject.tasks]; newTasks.splice(idx, 1); db.collection('projects').doc(currentEditingProject.id).update({ tasks: newTasks }); }
        function handleFileSelect(input) { if (input.files && input.files[0]) { selectedFile = input.files[0]; if (selectedFile.size > 500 * 1024) { alert("×§×•×‘×¥ ×’×“×•×œ ××“×™ (××§×¡×™××•× 500KB)"); selectedFile = null; return; } const d = safeGet('fileNameDisplay'); if(d) { d.textContent = selectedFile.name; d.classList.remove('hidden'); } } }
        function addActivityNote() { const txt = safeVal('newNoteText'); if(!txt.trim() && !selectedFile) return; const save = (fileData) => { const activity = { user: currentUser.email.split('@')[0], text: txt, date: new Date().toISOString(), file: fileData }; const newActs = [...(currentEditingProject.activities || []), activity]; db.collection('projects').doc(currentEditingProject.id).update({ activities: newActs }).then(() => { const noteBox = safeGet('newNoteText'); if(noteBox) noteBox.value = ''; const fDisplay = safeGet('fileNameDisplay'); if(fDisplay) fDisplay.classList.add('hidden'); selectedFile = null; }); }; if (selectedFile) { const reader = new FileReader(); reader.onload = (e) => save({ name: selectedFile.name, type: selectedFile.type, data: e.target.result }); reader.readAsDataURL(selectedFile); } else { save(null); } }
        function deleteActivity(idx) { if(!confirm('×œ××—×•×§?')) return; const acts = [...currentEditingProject.activities]; acts.splice(idx, 1); db.collection('projects').doc(currentEditingProject.id).update({ activities: acts }); }
        function renderActivityFeed() { const list = safeGet('activityFeed'); if(!list) return; const acts = currentEditingProject.activities || []; if(acts.length === 0) { list.innerHTML = '<div class="text-center text-gray-400 py-8 text-sm">××™×Ÿ ×¤×¢×™×œ×•×ª. ×”×™×” ×”×¨××©×•×Ÿ ×œ×¢×“×›×Ÿ!</div>'; return; } const sorted = acts.map((a, i) => ({...a, originalIndex: i})).sort((a,b) => new Date(b.date) - new Date(a.date)); list.innerHTML = sorted.map(a => { let fileHTML = ''; if(a.file) { if(a.file.type.startsWith('image/')) { fileHTML = `<br><img src="${a.file.data}" class="mt-3 rounded-xl border max-h-48 cursor-pointer hover:opacity-95 shadow-sm" onclick="window.open('${a.file.data}')">`; } else { fileHTML = `<br><a href="${a.file.data}" download="${a.file.name}" class="inline-flex items-center gap-3 mt-3 bg-blue-50 text-blue-700 px-4 py-2 rounded-xl text-sm border border-blue-100 hover:bg-blue-100 transition"><i class="fas fa-file-download text-lg"></i> ${a.file.name}</a>`; } } return `<div class="bg-white p-5 rounded-2xl border border-gray-100 flex gap-4 shadow-sm relative group hover:shadow-md transition"><div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-blue-600 text-white flex items-center justify-center font-bold flex-shrink-0 shadow-sm text-sm">${a.user.charAt(0).toUpperCase()}</div><div class="flex-1"><div class="flex justify-between items-center mb-1"><span class="font-bold text-sm text-gray-900">${a.user}</span><span class="text-xs text-gray-400 font-mono" dir="ltr">${new Date(a.date).toLocaleString('he-IL')}</span></div><p class="text-sm text-gray-600 leading-relaxed whitespace-pre-wrap">${a.text}</p>${fileHTML}</div><button onclick="deleteActivity(${a.originalIndex})" class="absolute top-4 left-4 text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition bg-white p-1.5 rounded-lg border border-gray-100 shadow-sm"><i class="fas fa-trash"></i></button></div>`; }).join(''); }
        function saveFullProject() { const oldStatus = currentEditingProject.status; const newStatus = safeVal('editStatus'); currentEditingProject.name = safeVal('editName'); currentEditingProject.estimatedCost = safeVal('editCost'); currentEditingProject.status = newStatus; currentEditingProject.owner = safeVal('editOwner'); currentEditingProject.startDate = safeVal('editStartDate'); currentEditingProject.endDate = safeVal('editEndDate'); currentEditingProject.objective = safeVal('editDesc'); db.collection('projects').doc(currentEditingProject.id).update(currentEditingProject).then(() => { if (oldStatus !== 'done' && newStatus === 'done') { const team = currentEditingProject.team || []; if (team.length > 0) { let emailPromises = []; const mailTitle = `×‘×¨×›×•×ª! ×”×¤×¨×•×™×§×˜ ×”×¡×ª×™×™× - ${currentEditingProject.name}`; const mailBody = `×”×¤×¨×•×™×§×˜ ×¡×•××Ÿ ×›"×”×•×©×œ×" ×‘××¢×¨×›×ª! ×ª×•×“×” ×¨×‘×” ×¢×œ ×”×¢×‘×•×“×” ×•×”×”×©×§×¢×”.`; team.forEach(memberEmail => { const p = emailjs.send("service_bk3qnf8", "template_8xea4xt", { to_email: memberEmail, email_title: mailTitle, email_message: mailBody, project_name: currentEditingProject.name, owner_name: currentEditingProject.owner, department: currentEditingProject.department }); emailPromises.push(p); }); alert('×”×¤×¨×•×™×§×˜ ×¢×•×“×›×Ÿ ×œ"×”×•×©×œ×" ×•××™×™×œ×™ ×¡×™×•× × ×©×œ×—×• ×œ×¦×•×•×ª! ğŸ'); } } closeFullModal(); }).catch(e => alert("×©×’×™××” ×‘×©××™×¨×”: " + e.message)); }
        function deleteCurrentProject() { if(confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×¤×¨×•×™×§×˜?')) db.collection('projects').doc(currentEditingProject.id).delete().then(() => closeFullModal()); }
        function closeFullModal() { safeRemoveClass('fullProjectModal', 'flex'); safeAddClass('fullProjectModal', 'hidden'); currentEditingProject = null; }
        function openNewProjectModal() { safeVal('npName', ''); const startInput = safeGet('npStart'); if(startInput) startInput.valueAsDate = new Date(); safeVal('npEnd', ''); safeVal('npCost', ''); document.querySelectorAll('#npTeam input').forEach(c => c.checked = false); safeRemoveClass('newProjectModal', 'hidden'); safeAddClass('newProjectModal', 'flex'); }
        function createNewProject() { const name = safeVal('npName'); const owner = safeVal('npOwner'); if(!name) return alert('×—×•×‘×” ×œ×”×–×™×Ÿ ×©× ×¤×¨×•×™×§×˜'); if(!owner) return alert('×—×•×‘×” ×œ×‘×—×•×¨ ××—×¨××™'); const team = []; document.querySelectorAll('#npTeam input:checked').forEach(cb => team.push(cb.value)); if (team.length === 0 && !confirm('×œ× × ×‘×—×¨×• ×©×•×ª×¤×™× ×œ×¤×¨×•×™×§×˜. ×œ× ×™×™×©×œ×—×• ××™×™×œ×™×. ×”×× ×œ×”××©×™×š?')) return; const newProj = { userId: currentUser.uid, name: name, site: safeVal('npSite'), department: safeVal('npDept'), owner: owner, priority: safeVal('npPriority'), startDate: safeVal('npStart'), endDate: safeVal('npEnd'), estimatedCost: safeVal('npCost'), status: 'planned', team: team, tasks: [], activities: [], progress: 0, createdAt: firebase.firestore.FieldValue.serverTimestamp() }; db.collection('projects').add(newProj).then(() => { if (team && team.length > 0) { let emailPromises = []; const mailTitle = `×¢×“×›×•×Ÿ: ×¤×¨×•×™×§×˜ ×—×“×© - ${name}`; const mailBody = `×©××—×™× ×œ×¢×“×›×Ÿ ×©× ×¤×ª×— ×¤×¨×•×™×§×˜ ×—×“×© ×‘××¢×¨×›×ª.`; team.forEach(memberEmail => { const p = emailjs.send("service_bk3qnf8", "template_8xea4xt", { to_email: memberEmail, email_title: mailTitle, email_message: mailBody, project_name: name, owner_name: owner, department: safeVal('npDept') }); emailPromises.push(p); }); Promise.all(emailPromises).then(() => { alert('×”×¤×¨×•×™×§×˜ × ×•×¦×¨ ×•×”××™×™×œ×™× × ×©×œ×—×• ×‘×”×¦×œ×—×”! ğŸ“§'); safeAddClass('newProjectModal', 'hidden'); safeRemoveClass('newProjectModal', 'flex'); }).catch((err) => { console.error(err); alert('×©×’×™××” ×‘×©×œ×™×—×ª ×”××™×™×œ×™×: ' + JSON.stringify(err)); safeAddClass('newProjectModal', 'hidden'); safeRemoveClass('newProjectModal', 'flex'); }); } else { alert('×”×¤×¨×•×™×§×˜ × ×•×¦×¨ (×œ×œ× ×©×œ×™×—×ª ××™×™×œ).'); safeAddClass('newProjectModal', 'hidden'); safeRemoveClass('newProjectModal', 'flex'); } }).catch(e => alert("×©×’×™××”: " + e.message)); }
        function exportToExcel() { let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; csvContent += "×©× ×”×¤×¨×•×™×§×˜,××ª×¨,××—×œ×§×”,××—×¨××™,×¡×˜×˜×•×¡,×ª×§×¦×™×‘,×”×ª×§×“××•×ª\n"; projectsData.forEach(p => { const row = [p.name, p.site, p.department, p.owner, STATUSES[p.status].label, p.estimatedCost, p.progress + '%'].join(","); csvContent += row + "\n"; }); const encodedUri = encodeURI(csvContent); const link = document.createElement("a"); link.setAttribute("href", encodedUri); link.setAttribute("download", "projects_report.csv"); document.body.appendChild(link); link.click(); }
        function openAnalyticsModal() { let totalBudget = 0; let highRiskCount = 0; let deptBudget = {}; let projectCosts = []; let ownerCounts = {}; let statusCounts = {}; let activeProjects = 0; projectsData.forEach(p => { const cost = Number(p.estimatedCost) || 0; totalBudget += cost; if(p.status === 'blocked') highRiskCount++; if(p.status === 'in-progress') activeProjects++; if(!deptBudget[p.department]) deptBudget[p.department] = 0; deptBudget[p.department] += cost; const ownerName = p.owner || '×œ× ×”×•×§×¦×”'; ownerCounts[ownerName] = (ownerCounts[ownerName] || 0) + 1; const statusLabel = STATUSES[p.status] ? STATUSES[p.status].label : '××—×¨'; statusCounts[statusLabel] = (statusCounts[statusLabel] || 0) + 1; projectCosts.push({ name: p.name, cost: cost }); }); safeText('totalBudgetDisplay', 'â‚ª' + totalBudget.toLocaleString()); safeText('totalProjectsDisplay', projectsData.length); safeText('highRiskDisplay', highRiskCount); safeText('activeProjectsDisplay', activeProjects); renderCharts(deptBudget, projectCosts, ownerCounts, statusCounts); safeRemoveClass('analyticsModal', 'hidden'); safeAddClass('analyticsModal', 'flex'); }
        function renderCharts(deptBudget, projectCosts, ownerCounts, statusCounts) { 
            let trendData = new Array(12).fill(0);
            projectsData.forEach(p => { if(p.tasks) { p.tasks.forEach(t => { if(t.dueDate) { const d = new Date(t.dueDate); if(d.getFullYear() === new Date().getFullYear()) { trendData[d.getMonth()]++; } } }); } });
            if(analyticsCharts.budget) analyticsCharts.budget.destroy(); if(analyticsCharts.top) analyticsCharts.top.destroy(); if(analyticsCharts.workload) analyticsCharts.workload.destroy(); if(analyticsCharts.status) analyticsCharts.status.destroy(); if(analyticsCharts.trend) analyticsCharts.trend.destroy();
            const ctx1 = document.getElementById('budgetChart').getContext('2d'); analyticsCharts.budget = new Chart(ctx1, { type: 'doughnut', data: { labels: Object.keys(deptBudget), datasets: [{ data: Object.values(deptBudget), backgroundColor: ['#3b82f6', '#6366f1', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'] }] }, options: { responsive: true, maintainAspectRatio: false } }); 
            const ctxWorkload = document.getElementById('workloadChart').getContext('2d'); analyticsCharts.workload = new Chart(ctxWorkload, { type: 'bar', data: { labels: Object.keys(ownerCounts), datasets: [{ label: '××¡×¤×¨ ×¤×¨×•×™×§×˜×™×', data: Object.values(ownerCounts), backgroundColor: '#8b5cf6', borderRadius: 6 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } } }); 
            const ctxStatus = document.getElementById('statusChart').getContext('2d'); analyticsCharts.status = new Chart(ctxStatus, { type: 'pie', data: { labels: Object.keys(statusCounts), datasets: [{ data: Object.values(statusCounts), backgroundColor: ['#e5e7eb', '#3b82f6', '#ef4444', '#10b981'] }] }, options: { responsive: true, maintainAspectRatio: false } }); 
            const top5 = projectCosts.sort((a,b) => b.cost - a.cost).slice(0, 5); const ctx2 = document.getElementById('topProjectsChart').getContext('2d'); analyticsCharts.top = new Chart(ctx2, { type: 'bar', data: { labels: top5.map(p => p.name.substring(0, 15) + '...'), datasets: [{ label: '×¢×œ×•×ª (â‚ª)', data: top5.map(p => p.cost), backgroundColor: '#6366f1', borderRadius: 6 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } } }); 
            const ctxTrend = document.getElementById('trendChart').getContext('2d'); analyticsCharts.trend = new Chart(ctxTrend, { type: 'line', data: { labels: ['×™× ×•××¨', '×¤×‘×¨×•××¨', '××¨×¥', '××¤×¨×™×œ', '×××™', '×™×•× ×™', '×™×•×œ×™', '××•×’×•×¡×˜', '×¡×¤×˜××‘×¨', '××•×§×˜×•×‘×¨', '× ×•×‘××‘×¨', '×“×¦××‘×¨'], datasets: [{ label: '×¦×¤×™ ×¡×™×•× ××©×™××•×ª', data: trendData, borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', fill: true, tension: 0.4 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } } });
        }
        function switchView(v) { currentView = v; renderProjects(); }
        function updateViewButtons(active) { const l = safeGet('viewBtnList'), k = safeGet('viewBtnKanban'); const act = "px-5 py-2 text-sm rounded-lg transition font-bold flex items-center gap-2 shadow-sm bg-white text-blue-600"; const inact = "px-5 py-2 text-sm rounded-lg transition font-medium flex items-center gap-2 text-slate-500 hover:bg-white hover:text-slate-700 hover:shadow-sm"; l.className = active === 'list' ? act : inact; k.className = active === 'kanban' ? act : inact; }
    </script>
</body>
</html>
