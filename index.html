<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>HomeOS V115 - Stable</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700;900&display=swap" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <style>
        /* BASE STYLES */
        body { 
            font-family: 'Heebo', sans-serif; 
            background-color: #0f172a; 
            color: white; 
            margin: 0; 
            padding: 0; 
            overflow-x: hidden; /* Critical for Mobile */
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
        }

        /* Prevent Zoom on Input */
        input, select, textarea { font-size: 16px !important; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(139, 92, 246, 0.5); border-radius: 10px; }

        /* Glass Effects */
        .glass { background: rgba(30, 41, 59, 0.85); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3); }
        .glass-heavy { background: #1e293b; border: 1px solid rgba(255, 255, 255, 0.1); }

        /* Animations */
        .animate-float { animation: float 6s ease-in-out infinite; }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-6px); } 100% { transform: translateY(0px); } }
        
        .modal-enter { animation: modalUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes modalUp { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        /* Inputs */
        input, select { background: #0f172a !important; border: 1px solid #334155 !important; color: white !important; height: 50px; }
        input:focus, select:focus { border-color: #8b5cf6 !important; ring: 2px solid #8b5cf6; }

        /* Background Orbs */
        #bg-fixed { position: fixed; inset: 0; z-index: -10; overflow: hidden; pointer-events: none; width: 100vw; height: 100vh; }
        .orb { position: absolute; border-radius: 50%; filter: blur(90px); opacity: 0.4; }
    </style>
</head>
<body>

    <div id="bg-fixed">
        <div class="orb w-[300px] h-[300px] bg-purple-600 top-[-50px] left-[-50px]"></div>
        <div class="orb w-[300px] h-[300px] bg-blue-600 bottom-[-50px] right-[-50px]"></div>
    </div>

    <div id="loginScreen" class="fixed inset-0 flex items-center justify-center bg-slate-900/95 backdrop-blur-xl z-[100] p-6">
        <div class="glass p-8 rounded-3xl shadow-2xl w-full max-w-sm text-center modal-enter">
            <div class="w-20 h-20 bg-gradient-to-br from-purple-600 to-indigo-600 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg animate-float">
                <i class="fas fa-rocket text-4xl text-white"></i>
            </div>
            <h2 class="text-3xl font-black mb-2 text-white">HomeOS</h2>
            <p class="text-slate-400 text-sm mb-8">×›× ×™×¡×” ×œ××©×¤×—×”</p>
            <div id="authError" class="hidden bg-red-500/20 text-red-300 p-3 rounded-xl mb-4 text-xs font-bold border border-red-500/30"></div>
            <input type="email" id="emailInput" placeholder="××™××™×™×œ" class="w-full px-5 rounded-xl mb-3 outline-none" dir="ltr">
            <input type="password" id="passInput" placeholder="×¡×™×¡××”" class="w-full px-5 rounded-xl mb-6 outline-none" dir="ltr">
            <button onclick="handleAuth()" class="w-full bg-gradient-to-r from-purple-600 to-blue-600 text-white font-bold py-4 rounded-xl shadow-lg active:scale-95 transition">×›× ×™×¡×”</button>
        </div>
    </div>

    <div id="sidebarOverlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/60 z-[60] hidden backdrop-blur-sm transition-opacity"></div>
    <aside id="sidebar" class="fixed inset-y-0 right-0 w-72 glass-heavy z-[70] transition-transform duration-300 flex flex-col transform translate-x-full shadow-2xl">
        <div class="p-8 flex items-center gap-4 border-b border-white/5">
            <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-xl flex items-center justify-center text-white"><i class="fas fa-user-astronaut"></i></div>
            <div><h1 class="text-xl font-black tracking-wider">HOME<span class="text-purple-400">OS</span></h1><p class="text-[10px] font-bold text-slate-400" id="currentUserDisplaySidebar">USER</p></div>
            <button onclick="toggleSidebar()" class="mr-auto text-slate-400 p-2"><i class="fas fa-times text-xl"></i></button>
        </div>
        <nav class="flex-1 px-4 space-y-3 overflow-y-auto py-6">
            <button onclick="switchPage('dashboard')" id="nav-dashboard" class="w-full flex items-center gap-4 px-5 py-4 rounded-2xl text-sm font-bold bg-white/5 text-white border border-purple-500/30"><i class="fas fa-chart-pie text-purple-400 w-5"></i> ×“×©×‘×•×¨×“</button>
            <button onclick="switchPage('transactions')" id="nav-transactions" class="w-full flex items-center gap-4 px-5 py-4 rounded-2xl text-sm font-bold text-slate-400 hover:bg-white/5"><i class="fas fa-list-ul w-5"></i> ×ª× ×•×¢×•×ª</button>
            <button onclick="switchPage('planner')" id="nav-planner" class="w-full flex items-center gap-4 px-5 py-4 rounded-2xl text-sm font-bold text-slate-400 hover:bg-white/5"><i class="fas fa-space-shuttle w-5"></i> ×¤×¨×•×™×§×˜×™×</button>
            <button onclick="switchPage('contacts')" id="nav-contacts" class="w-full flex items-center gap-4 px-5 py-4 rounded-2xl text-sm font-bold text-slate-400 hover:bg-white/5"><i class="fas fa-users w-5"></i> ×× ×©×™ ×§×©×¨</button>
            <div class="pt-8 pb-2 text-[10px] font-bold text-slate-600 px-5 uppercase">×›×œ×™×</div>
            <button onclick="exportToExcel()" class="w-full flex items-center gap-4 px-5 py-3 rounded-2xl text-sm font-bold text-slate-400"><i class="fas fa-file-excel w-5"></i> ××§×¡×œ</button>
             <button onclick="resetData()" class="w-full flex items-center gap-4 px-5 py-3 rounded-2xl text-sm font-bold text-slate-400"><i class="fas fa-trash-alt w-5"></i> ××™×¤×•×¡</button>
        </nav>
        <div class="p-6 border-t border-white/5"><button onclick="openProfileModal()" class="w-full text-center text-xs text-purple-400 font-bold py-2">×”×’×“×¨×•×ª ×—×©×‘×•×Ÿ</button></div>
    </aside>

    <div class="min-h-screen flex flex-col relative z-10 w-full overflow-x-hidden">
        <header class="p-5 flex justify-between items-center z-30 shrink-0">
            <div class="flex items-center gap-4">
                <button onclick="toggleSidebar()" class="w-12 h-12 glass rounded-2xl flex items-center justify-center text-white active:scale-95 transition"><i class="fas fa-bars text-xl"></i></button>
                <h2 class="text-xl font-black text-white" id="pageTitle">××¨×›×– ×©×œ×™×˜×”</h2>
            </div>
            <div class="flex gap-3">
                <button onclick="openProfileModal()" class="w-12 h-12 glass rounded-full flex items-center justify-center relative active:scale-95 transition"><i class="fas fa-user-circle text-white text-xl"></i></button>
                <div class="relative">
                    <button onclick="toggleNotifications()" class="w-12 h-12 glass rounded-full flex items-center justify-center relative active:scale-95 transition"><i class="fas fa-bell text-white text-xl"></i><span id="notifBadge" class="hidden absolute top-1 right-1 w-3 h-3 bg-red-500 rounded-full border border-slate-900"></span></button>
                    <div id="notifDropdown" class="hidden absolute top-14 left-0 w-72 glass rounded-2xl border border-white/10 overflow-hidden z-50 origin-top-left"><div class="p-4 border-b border-white/10 bg-black/20 font-bold text-sm text-white flex justify-between"><span>×¢×“×›×•× ×™×</span><button onclick="clearNotifications()" class="text-xs text-blue-400">× ×§×”</button></div><div id="notifList" class="max-h-60 overflow-y-auto"></div></div>
                </div>
            </div>
        </header>

        <main class="flex-1 p-4 pb-28 w-full max-w-lg mx-auto" id="contentArea">
            <div id="view-dashboard" class="space-y-6">
                <div class="glass p-6 rounded-3xl relative overflow-hidden">
                    <div class="absolute inset-0 bg-gradient-to-r from-purple-600/20 to-blue-600/20"></div>
                    <div class="relative z-10">
                        <p class="text-slate-400 text-sm font-medium mb-1">×™×ª×¨×” ×¤× ×•×™×”</p>
                        <h2 class="text-5xl font-black tracking-tight text-white mb-6" id="dashBalance">â‚ª0</h2>
                        <div class="grid grid-cols-2 gap-3"><div class="bg-black/30 rounded-xl p-3 border border-white/5"><p class="text-xs text-slate-400">×”×›× ×¡×•×ª</p><p class="text-green-400 font-bold text-lg" id="dashIncome">0</p></div><div class="bg-black/30 rounded-xl p-3 border border-white/5"><p class="text-xs text-slate-400">×”×•×¦××•×ª</p><p class="text-red-400 font-bold text-lg" id="dashExpense">0</p></div></div>
                    </div>
                </div>
                <div class="glass p-4 rounded-3xl"><h3 class="font-bold text-slate-300 mb-4 text-sm">××’××”</h3><div class="h-48"><canvas id="monthlyChart"></canvas></div></div>
            </div>
            <div id="view-transactions" class="hidden space-y-4"><div class="glass p-3 rounded-2xl flex items-center border border-white/5"><i class="fas fa-search text-slate-400 mr-4 ml-2"></i><input type="text" id="searchBox" onkeyup="renderTable()" placeholder="×—×™×¤×•×©..." class="bg-transparent border-none w-full text-white placeholder-slate-500 focus:ring-0 !border-0 !bg-transparent h-auto"></div><div id="transactionsListMobile" class="space-y-3"></div></div>
            <div id="view-planner" class="hidden space-y-4"><div class="flex justify-end"><button onclick="openPlannerHeaderModal(true)" class="px-5 py-3 rounded-xl bg-purple-600 text-white font-bold shadow-lg flex items-center gap-2 text-sm"><i class="fas fa-plus"></i> ×¤×¨×•×™×§×˜ ×—×“×©</button></div><div id="plansContainer" class="space-y-4"></div></div>
            <div id="view-contacts" class="hidden space-y-4"><div class="flex justify-end"><button onclick="openContactModal()" class="px-5 py-3 rounded-xl bg-blue-600 text-white font-bold shadow-lg flex items-center gap-2 text-sm"><i class="fas fa-user-plus"></i> ×”×•×¡×¤×”</button></div><div id="contactsContainer" class="space-y-4"></div></div>
        </main>

        <button id="mainAddBtn" onclick="openModal('new')" class="fixed bottom-6 left-6 w-14 h-14 bg-gradient-to-r from-purple-600 to-blue-600 rounded-full shadow-lg shadow-purple-500/40 flex items-center justify-center text-white text-2xl active:scale-90 transition z-50"><i class="fas fa-plus"></i></button>
        <div id="toastContainer" class="fixed bottom-24 right-6 left-6 z-[100] flex flex-col gap-2 pointer-events-none"></div>
    </div>

    <div id="profileModal" class="fixed inset-0 z-[90] hidden items-center justify-center bg-black/80 backdrop-blur-sm p-4">
        <div class="glass-heavy w-full max-w-sm rounded-3xl border border-white/10 shadow-2xl flex flex-col modal-enter">
            <div class="p-6 border-b border-white/10 flex justify-between items-center bg-white/5"><h3 class="text-xl font-black text-white">×¤×¨×•×¤×™×œ ××™×©×™</h3><button onclick="closeModal('profileModal')" class="text-white"><i class="fas fa-times"></i></button></div>
            <div class="p-6 space-y-6">
                <div class="text-center"><div class="w-20 h-20 bg-gradient-to-br from-cyan-500 to-blue-600 rounded-full mx-auto flex items-center justify-center text-3xl font-bold mb-3 shadow-lg"><i class="fas fa-user-astronaut text-white"></i></div><p class="text-slate-400 text-sm">××—×•×‘×¨ ×›:</p><p class="text-xl font-bold text-white" id="profileEmailDisplay">...</p></div>
                <div class="border-t border-white/10 pt-4"><label class="text-xs text-slate-400 mb-2 block">×©×™× ×•×™ ×¡×™×¡××”</label><div class="flex gap-2"><input type="password" id="newPasswordInput" placeholder="×¡×™×¡××” ×—×“×©×”" class="w-full px-4 rounded-xl text-sm"><button onclick="changePassword()" class="px-4 rounded-xl bg-slate-700 text-white font-bold text-sm whitespace-nowrap">×¢×“×›×Ÿ</button></div></div>
                <div class="border-t border-white/10 pt-4"><button onclick="doLogout()" class="w-full py-3 rounded-xl bg-red-500/10 text-red-400 border border-red-500/20 font-bold flex items-center justify-center gap-2 hover:bg-red-500/20 transition"><i class="fas fa-sign-out-alt"></i> ×”×ª× ×ª×§</button></div>
            </div>
        </div>
    </div>

    <div id="transactionModal" class="fixed inset-0 z-[80] hidden items-center justify-center bg-black/80 backdrop-blur-sm p-4">
        <div class="glass-heavy w-full max-w-md rounded-3xl border border-white/10 shadow-2xl flex flex-col max-h-[90vh] modal-enter relative" id="modalBox">
            <div class="p-6 border-b border-white/10 flex justify-between items-center bg-white/5">
                <h3 id="modalTitle" class="text-xl font-black text-white">×”×•×¡×¤×”</h3>
                <button onclick="closeModal('transactionModal')" class="w-10 h-10 rounded-full bg-white/5 flex items-center justify-center text-white"><i class="fas fa-times"></i></button>
            </div>
            
            <div id="projectContextBanner" class="hidden bg-purple-600/20 px-6 py-2 border-b border-white/5">
                <p class="text-xs text-purple-300 font-bold flex items-center gap-2"><i class="fas fa-link"></i> <span id="projectContextName"></span></p>
            </div>

            <div class="p-6 space-y-5 overflow-y-auto">
                <input type="hidden" id="editId"><input type="hidden" id="linkedPlanId"><input type="hidden" id="linkedPlanName">
                
                <div id="advancedFields">
                    <div class="flex bg-black/30 p-1 rounded-xl mb-4 border border-white/5"><button onclick="setType('expense')" id="btnTypeExpense" class="flex-1 py-3 rounded-lg font-bold text-sm transition">×”×•×¦××”</button><button onclick="setType('income')" id="btnTypeIncome" class="flex-1 py-3 rounded-lg font-bold text-sm transition">×”×›× ×¡×”</button></div>
                    <input type="hidden" id="pType" value="expense">
                    <div class="grid grid-cols-2 gap-4 mb-4"><div><label class="text-xs text-slate-400 mb-1 block">×¡×˜×˜×•×¡</label><select id="pStatus" class="w-full px-3 rounded-xl text-sm"><option value="planned">ğŸ“… ×¢×ª×™×“×™</option><option value="in-progress">ğŸ’³ ×‘×ª×”×œ×™×š</option><option value="done">âœ… ×©×•×œ×</option></select></div><div><label class="text-xs text-slate-400 mb-1 block">×©×™×•×š</label><select id="pOwner" class="w-full px-3 rounded-xl text-sm"><option value="××©×•×ª×£">ğŸ  ××©×•×ª×£</option><option value="×—×’×™">ğŸ‘¨ ×—×’×™</option><option value="×××‘×¨">ğŸ‘© ×××‘×¨</option></select></div></div>
                    <div class="mb-4"><label class="text-xs text-slate-400 mb-1 block">×§×˜×’×•×¨×™×”</label><select id="pDept" class="w-full px-3 rounded-xl text-sm"></select></div>
                </div>

                <div><label class="text-xs text-slate-400 mb-1 block">×ª×™××•×¨</label><input type="text" id="pName" class="w-full px-4 rounded-xl text-lg font-bold" placeholder="××” ×§× ×™× ×•?"></div>
                <div class="grid grid-cols-2 gap-4"><div><label class="text-xs text-slate-400 mb-1 block">×¡×›×•×</label><input type="number" id="pCost" class="w-full px-4 rounded-xl font-mono text-xl font-bold text-red-400 bg-red-500/10" placeholder="0"></div><div><label class="text-xs text-slate-400 mb-1 block">×ª××¨×™×š</label><input type="date" id="pStart" class="w-full px-4 rounded-xl text-sm"></div></div>
            </div>
            
            <div class="p-6 border-t border-white/10 flex gap-3 bg-black/20">
                <button onclick="deleteItem()" id="btnDelete" class="w-12 h-12 flex items-center justify-center rounded-xl bg-red-500/10 text-red-400 hidden"><i class="fas fa-trash"></i></button>
                <button onclick="saveItem()" class="flex-1 h-12 rounded-xl bg-purple-600 text-white font-bold shadow-lg text-lg">×©××•×¨</button>
            </div>
        </div>
    </div>

    <div id="plannerDetailModal" class="fixed inset-0 z-[80] hidden items-center justify-center bg-black/90 backdrop-blur-sm p-4">
        <div class="glass-heavy w-full max-w-4xl h-[85vh] rounded-3xl border border-white/10 shadow-2xl flex flex-col modal-enter overflow-hidden">
            <div class="p-6 border-b border-white/10 bg-gradient-to-r from-purple-900 to-indigo-900 flex justify-between items-center shrink-0">
                <div><h3 class="text-2xl font-black text-white" id="detailPlanName"></h3><p class="text-purple-200 text-xs mt-1" id="detailPlanLimit"></p></div>
                <div class="flex items-center gap-2"><button onclick="openTransactionForPlan()" class="bg-white/20 px-4 py-2 rounded-xl font-bold text-sm text-white shadow-lg"><i class="fas fa-plus"></i></button><button onclick="closeModal('plannerDetailModal')" class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center text-white"><i class="fas fa-times"></i></button></div>
            </div>
            <div class="p-6 overflow-y-auto flex-1 bg-black/20">
                <input type="hidden" id="detailPlanIdHidden">
                <div class="glass p-4 rounded-2xl border border-white/5 shadow-lg mb-6">
                    <div class="flex justify-between mb-2"><div class="text-center"><p class="text-[10px] text-slate-400">× ×•×¦×œ</p><p class="text-xl font-bold text-white" id="detailUsed">â‚ª0</p></div><div class="text-center"><p class="text-[10px] text-slate-400">× ×•×ª×¨</p><p class="text-xl font-bold" id="detailLeft">â‚ª0</p></div></div>
                    <div class="w-full bg-white/10 h-5 rounded-full overflow-hidden relative"><div id="detailProgress" class="h-full bg-purple-500 transition-all duration-500 flex items-center justify-center" style="width: 0%"></div><span id="detailPercentText" class="absolute inset-0 flex items-center justify-center text-[10px] font-bold text-white drop-shadow-md">0%</span></div>
                </div>
                <h4 class="font-bold text-slate-400 mb-3 text-xs uppercase tracking-wider">×¤×™×¨×•×˜ ×”×•×¦××•×ª</h4>
                <div id="detailItemsContainer" class="space-y-3"></div>
            </div>
        </div>
    </div>

    <div id="plannerHeaderModal" class="fixed inset-0 z-[80] hidden items-center justify-center bg-black/80 backdrop-blur-sm p-4"><div class="glass-heavy w-full max-w-sm rounded-3xl border border-white/10 shadow-2xl flex flex-col modal-enter"><div class="p-6 border-b border-white/10 bg-gradient-to-r from-purple-900/50 to-blue-900/50 rounded-t-3xl flex justify-between items-center"><h3 class="text-xl font-black text-white">×¤×¨×•×™×§×˜ ×—×“×©</h3><button onclick="closeModal('plannerHeaderModal')" class="text-white"><i class="fas fa-times"></i></button></div><div class="p-6 space-y-4"><input type="hidden" id="editPlanId"><div><label class="text-xs text-slate-400 block mb-1">×©×</label><input type="text" id="planName" class="w-full px-4 rounded-xl"></div><div><label class="text-xs text-slate-400 block mb-1">×ª×§×¦×™×‘</label><input type="number" id="planLimit" class="w-full px-4 rounded-xl font-mono text-lg font-bold"></div></div><div class="p-6 pt-0"><button onclick="savePlanHeader()" class="w-full py-3 rounded-xl bg-purple-600 text-white font-bold shadow-lg">×©××•×¨</button></div></div></div>
    <div id="contactModal" class="fixed inset-0 z-[80] hidden items-center justify-center bg-black/80 backdrop-blur-sm p-4"><div class="glass-heavy w-full max-w-sm rounded-3xl border border-white/10 shadow-2xl flex flex-col modal-enter"><div class="p-6 border-b border-white/10 bg-blue-900/30 rounded-t-3xl flex justify-between items-center"><h3 class="text-xl font-black text-blue-200">××™×© ×§×©×¨</h3><button onclick="closeModal('contactModal')" class="text-white"><i class="fas fa-times"></i></button></div><div class="p-6 space-y-4"><input type="text" id="contactName" placeholder="×©×" class="w-full px-4 rounded-xl"><input type="text" id="contactRole" placeholder="×ª×¤×§×™×“" class="w-full px-4 rounded-xl"><input type="tel" id="contactPhone" placeholder="×˜×œ×¤×•×Ÿ" class="w-full px-4 rounded-xl font-mono"><input type="email" id="contactEmail" placeholder="××™××™×™×œ" class="w-full px-4 rounded-xl"></div><div class="p-6 pt-0"><button onclick="saveContact()" class="w-full py-3 rounded-xl bg-blue-600 text-white font-bold shadow-lg">×©××•×¨</button></div></div></div>

    <script>
        const EMAILJS_SERVICE_ID = "YOUR_SERVICE_ID"; // UPDATE
        const EMAILJS_TEMPLATE_ID = "YOUR_TEMPLATE_ID"; // UPDATE
        const EMAILJS_PUBLIC_KEY = "YOUR_PUBLIC_KEY"; // UPDATE

        const firebaseConfig = {
            apiKey: "AIzaSyB7U5xw_FMThsmM2hNMRnkdMYnD2cutH2s",
            authDomain: "project-manager-4702c.firebaseapp.com",
            databaseURL: "https://project-manager-4702c-default-rtdb.firebaseio.com",
            projectId: "project-manager-4702c",
            storageBucket: "project-manager-4702c.firebasestorage.app",
            messagingSenderId: "941533299304",
            appId: "1:941533299304:web:92f8940e93a96b1f8b71dd"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        (function(){ try { emailjs.init(EMAILJS_PUBLIC_KEY); } catch(e){} })();

        const ALLOWED_EMAILS = ['hagay1989@gmail.com', 'ambartimsit@gmail.com'];
        let items=[], plans=[], contacts=[], notifications=[], currentUser="", currentEmail="";
        let chartMonthly=null, chartCategory=null;

        auth.onAuthStateChanged(user => {
            if (user) {
                const email = user.email.toLowerCase();
                if(!ALLOWED_EMAILS.includes(email)) { alert('×’×™×©×” × ×“×—×ª×”.'); auth.signOut(); return; }
                currentUser = email.includes('hagay') ? '×—×’×™' : '×××‘×¨'; currentEmail = email;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('currentUserDisplay').textContent = currentUser;
                document.getElementById('currentUserDisplaySidebar').textContent = currentUser;
                document.getElementById('profileEmailDisplay').textContent = email;
                initApp();
            } else { document.getElementById('loginScreen').classList.remove('hidden'); }
        });
        function handleAuth() { auth.signInWithEmailAndPassword(document.getElementById('emailInput').value, document.getElementById('passInput').value).catch(e => { document.getElementById('authError').textContent = e.message; document.getElementById('authError').classList.remove('hidden'); }); }

        function initApp() {
            db.collection('family_transactions').onSnapshot(snap => { items = snap.docs.map(d => ({id: d.id, ...d.data()})); updateDashboard(); renderTable(); 
                const detailId = document.getElementById('detailPlanIdHidden').value; if(detailId && !document.getElementById('plannerDetailModal').classList.contains('hidden')) updateDetailModal(detailId); 
            });
            db.collection('family_plans').onSnapshot(snap => { plans = snap.docs.map(d => ({id: d.id, ...d.data()})); renderPlanner(); });
            db.collection('family_contacts').onSnapshot(snap => { contacts = snap.docs.map(d => ({id: d.id, ...d.data()})); renderContacts(); });
            renderNotifications();
        }

        // --- SMART MODAL LOGIC (FIXED) ---
        function openTransactionForPlan() {
            const planId = document.getElementById('detailPlanIdHidden').value;
            const p = plans.find(x => x.id === planId);
            openModal('project_item', p.name); 
            document.getElementById('linkedPlanId').value = planId;
            document.getElementById('linkedPlanName').value = p.name;
            // Defaults
            document.getElementById('pDept').value = "ğŸ“¦ ×©×•× ×•×ª"; 
            document.getElementById('pStatus').value = "done"; 
            document.getElementById('pOwner').value = "××©×•×ª×£";
        }

        function openModal(mode, extraTitle = '') { 
            document.getElementById('transactionModal').classList.remove('hidden'); 
            document.getElementById('transactionModal').classList.add('flex');
            
            // Clean up
            if (mode === 'new' || mode === 'project_item') {
                document.getElementById('editId').value='';
                document.getElementById('pName').value=''; 
                document.getElementById('pCost').value=''; 
                document.getElementById('btnDelete').classList.add('hidden'); 
                document.getElementById('pStart').valueAsDate=new Date(); 
                setType('expense');
            }

            const adv = document.getElementById('advancedFields');
            const ctxBanner = document.getElementById('projectContextBanner');

            if (mode === 'project_item') {
                adv.classList.add('hidden');
                ctxBanner.classList.remove('hidden');
                document.getElementById('projectContextName').textContent = extraTitle;
                document.getElementById('modalTitle').textContent = "×”×•×¡×¤×” ××”×™×¨×”";
                document.getElementById('pName').placeholder = "×©× ×”×¤×¨×™×˜";
            } else {
                adv.classList.remove('hidden');
                ctxBanner.classList.add('hidden');
                document.getElementById('modalTitle').textContent = mode === 'edit' ? "×¢×¨×™×›×”" : "×”×•×¡×¤×”";
                document.getElementById('pName').placeholder = "×ª×™××•×¨";
                if(mode==='new'){
                    document.getElementById('linkedPlanId').value='';
                    document.getElementById('linkedPlanName').value='';
                }
            }
        }

        function editItem(id) { 
            const i=items.find(x=>x.id===id); if(!i) return; 
            
            // Check context
            if(i.linkedPlanId) {
                openModal('project_item', i.linkedPlanName);
            } else {
                openModal('edit');
            }

            setType(i.type||'expense'); 
            document.getElementById('editId').value=id; 
            document.getElementById('pName').value=i.name; 
            document.getElementById('pStatus').value=i.status; 
            document.getElementById('pDept').value=i.department; 
            document.getElementById('pOwner').value=i.owner; 
            document.getElementById('pStart').value=i.startDate; 
            document.getElementById('pCost').value=i.estimatedCost; 
            document.getElementById('linkedPlanId').value=i.linkedPlanId||''; 
            document.getElementById('btnDelete').classList.remove('hidden'); 
        }

        // --- Standard Logic ---
        function openProfileModal() { document.getElementById('profileModal').classList.remove('hidden'); document.getElementById('profileModal').classList.add('flex'); document.getElementById('newPasswordInput').value = ''; }
        function changePassword() { const newPass = document.getElementById('newPasswordInput').value; if (newPass.length < 6) return showToast('×¡×™×¡××” ×§×¦×¨×” ××“×™'); const user = firebase.auth().currentUser; user.updatePassword(newPass).then(() => { showToast('×”×¡×™×¡××” ×©×•× ×ª×”!'); closeModal('profileModal'); }).catch((e) => { if(e.code==='auth/requires-recent-login') { alert('× × ×œ×”×ª×—×‘×¨ ××—×“×©'); doLogout(); } else showToast('×©×’×™××”: '+e.message); }); }
        function doLogout() { auth.signOut().then(() => window.location.reload()); }
        function openDetailModal(id) { document.getElementById('detailPlanIdHidden').value=id; document.getElementById('plannerDetailModal').classList.remove('hidden'); document.getElementById('plannerDetailModal').classList.add('flex'); updateDetailModal(id); }
        function updateDetailModal(id) {
            const p = plans.find(x => x.id === id); if(!p) return;
            document.getElementById('detailPlanName').textContent = p.name;
            document.getElementById('detailPlanLimit').textContent = '×ª×§×¦×™×‘: â‚ª' + Number(p.limit).toLocaleString();
            const planItems = items.filter(i => i.linkedPlanId === id);
            const used = planItems.reduce((s,i) => s + (Number(i.estimatedCost)||0), 0);
            const rem = (Number(p.limit)||0) - used;
            document.getElementById('detailUsed').textContent = 'â‚ª' + used.toLocaleString();
            document.getElementById('detailLeft').textContent = 'â‚ª' + rem.toLocaleString();
            document.getElementById('detailLeft').className = rem < 0 ? "text-xl font-bold text-red-400" : "text-xl font-bold text-green-400";
            const pct = (p.limit>0) ? Math.min((used/p.limit)*100, 100) : 0;
            document.getElementById('detailProgress').style.width = pct + '%';
            document.getElementById('detailPercentText').textContent = Math.round(pct) + '%';
            document.getElementById('detailProgress').className = rem < 0 ? "h-full bg-red-500 flex items-center justify-center" : "h-full bg-gradient-to-r from-purple-500 to-indigo-500 flex items-center justify-center";
            document.getElementById('detailItemsContainer').innerHTML = planItems.length===0 ? '<div class="text-center py-10 text-slate-500">×¨×™×§</div>' : planItems.sort((a,b)=>new Date(b.startDate)-new Date(a.startDate)).map(i => `
                <div onclick="editItem('${i.id}')" class="glass p-4 rounded-2xl border border-white/5 hover:bg-white/10 cursor-pointer flex justify-between items-center transition group">
                    <div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full bg-purple-500/20 text-purple-400 flex items-center justify-center font-bold text-lg"><i class="fas fa-rocket"></i></div><div><h4 class="font-bold text-white text-sm">${i.name}</h4><p class="text-[10px] text-slate-400">${i.startDate} â€¢ ${i.status==='done'?'âœ…':'â³'}</p></div></div><div class="text-left"><p class="font-black text-lg text-white">â‚ª${Number(i.estimatedCost).toLocaleString()}</p></div></div>`).join('');
        }
        const CAT_EXPENSE = ['ğŸ›’ ×¡×•×¤×¨','ğŸ  ××©×›× ×ª×','ğŸš— ×¨×›×‘','ğŸ“ ×—×™× ×•×š','âœˆï¸ ×‘×™×œ×•×™','ğŸ’¡ ×—×©×‘×•× ×•×ª','ğŸ’Š ×‘×¨×™××•×ª','ğŸ“¦ ×©×•× ×•×ª'];
        const CAT_INCOME = ['ğŸ’° ××©×›×•×¨×ª','ğŸ ××¢× ×§','ğŸ“ˆ ×”×©×§×¢×•×ª'];
        function setType(t) { document.getElementById('pType').value=t; const e=document.getElementById('btnTypeExpense'), i=document.getElementById('btnTypeIncome'), s=document.getElementById('pDept'), c=document.getElementById('pCost'); if(t==='expense'){ e.className="flex-1 py-3 rounded-lg font-bold bg-red-500 text-white shadow-lg"; i.className="flex-1 py-3 rounded-lg font-bold text-slate-400 hover:text-white"; s.innerHTML=CAT_EXPENSE.map(x=>`<option>${x}</option>`).join(''); c.classList.remove('text-green-400'); c.classList.add('text-red-400'); } else { i.className="flex-1 py-3 rounded-lg font-bold bg-green-500 text-white shadow-lg"; e.className="flex-1 py-3 rounded-lg font-bold text-slate-400 hover:text-white"; s.innerHTML=CAT_INCOME.map(x=>`<option>${x}</option>`).join(''); c.classList.remove('text-red-400'); c.classList.add('text-green-400'); } }
        function saveItem() {
            const id=document.getElementById('editId').value, name=document.getElementById('pName').value, cost=document.getElementById('pCost').value;
            const data={type:document.getElementById('pType').value,name:name,status:document.getElementById('pStatus').value,department:document.getElementById('pDept').value,owner:document.getElementById('pOwner').value,startDate:document.getElementById('pStart').value,estimatedCost:Number(cost),linkedPlanId:document.getElementById('linkedPlanId').value||null,linkedPlanName:document.getElementById('linkedPlanName').value||null,updatedAt:firebase.firestore.FieldValue.serverTimestamp()};
            if(id) db.collection('family_transactions').doc(id).update(data).then(()=>{ closeModal('transactionModal'); showToast('×¢×•×“×›×Ÿ'); }); 
            else { data.createdAt=firebase.firestore.FieldValue.serverTimestamp(); data.userId=auth.currentUser.uid; db.collection('family_transactions').add(data).then(()=>{ closeModal('transactionModal'); addNotification(`${currentUser} ×”×•×¡×™×£: ${name}`); sendEmailNotification(name, cost); }); }
        }
        function deleteItem(){ if(confirm('×œ××—×•×§?')) db.collection('family_transactions').doc(document.getElementById('editId').value).delete().then(()=>closeModal('transactionModal')); }
        function sendEmailNotification(name, cost) { const targetEmail=currentEmail.includes('hagay')?'Ambartimsit@gmail.com':'Hagay1989@gmail.com'; const targetName=currentEmail.includes('hagay')?'×××‘×¨':'×—×’×™'; emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, { to_name: targetName, to_email: targetEmail, from_name: currentUser, message: `× ×•×¡×¤×”: ${name} (â‚ª${cost})` }); }
        function showToast(msg) { const c=document.getElementById('toastContainer'), t=document.createElement('div'); t.className="glass p-3 rounded-xl flex items-center gap-3 text-white pointer-events-auto animate-float border border-white/10 shadow-lg backdrop-blur-md min-w-[250px]"; t.innerHTML=`<i class="fas fa-check-circle text-green-400 text-lg"></i><div><p class="font-bold text-sm text-slate-200">${msg}</p></div>`; c.appendChild(t); setTimeout(()=>t.remove(),3000); }
        function addNotification(msg) { notifications.unshift({msg, time: new Date()}); document.getElementById('notifBadge').classList.remove('hidden'); renderNotifications(); }
        function renderNotifications() { document.getElementById('notifList').innerHTML = notifications.length===0 ? '<div class="p-4 text-center text-xs text-slate-500">×¨×™×§...</div>' : notifications.map(n => `<div class="p-3 border-b border-white/5 hover:bg-white/5 transition"><p class="text-xs font-bold text-white">${n.msg}</p><p class="text-[10px] text-slate-400">${n.time.toLocaleTimeString()}</p></div>`).join(''); }
        function toggleNotifications() { document.getElementById('notifDropdown').classList.toggle('hidden'); document.getElementById('notifBadge').classList.add('hidden'); }
        function clearNotifications() { notifications=[]; renderNotifications(); }
        function closeModal(id){ document.getElementById(id).classList.add('hidden'); document.getElementById(id).classList.remove('flex'); }
        function switchPage(p){ ['dashboard','transactions','planner','contacts'].forEach(v=>document.getElementById('view-'+v).classList.add('hidden')); document.getElementById('view-'+p).classList.remove('hidden'); document.getElementById('pageTitle').textContent=p==='dashboard'?'××¨×›×– ×©×œ×™×˜×”':(p==='transactions'?'×ª× ×•×¢×•×ª':(p==='planner'?'×¤×¨×•×™×§×˜×™×':'×× ×©×™ ×§×©×¨')); if(p==='transactions') renderTable(); if(window.innerWidth<768) toggleSidebar(); }
        function toggleSidebar(){ const s=document.getElementById('sidebar'); const o=document.getElementById('sidebarOverlay'); if(s.classList.contains('translate-x-full')) { s.classList.remove('translate-x-full'); o.classList.remove('hidden'); } else { s.classList.add('translate-x-full'); o.classList.add('hidden'); } }
        function openPlannerHeaderModal(){ document.getElementById('plannerHeaderModal').classList.remove('hidden'); document.getElementById('plannerHeaderModal').classList.add('flex'); document.getElementById('planName').value=''; document.getElementById('planLimit').value=''; }
        function savePlanHeader(){ const n=document.getElementById('planName').value, l=document.getElementById('planLimit').value; if(!n) return alert('×—×¡×¨ ×©×'); db.collection('family_plans').add({name:n,limit:Number(l),userId:auth.currentUser.uid,createdAt:firebase.firestore.FieldValue.serverTimestamp()}).then(()=>closeModal('plannerHeaderModal')); }
        function deletePlan(id){ if(confirm('×œ××—×•×§ ×¤×¨×•×™×§×˜?')) db.collection('family_plans').doc(id).delete(); }
        function openContactModal(){ document.getElementById('contactModal').classList.remove('hidden'); document.getElementById('contactModal').classList.add('flex'); }
        function saveContact(){ const n=document.getElementById('contactName').value, r=document.getElementById('contactRole').value, p=document.getElementById('contactPhone').value, e=document.getElementById('contactEmail').value; db.collection('family_contacts').add({name:n,role:r,phone:p,email:e}).then(()=>closeModal('contactModal')); }
        function deleteContact(id){ if(confirm('×œ××—×•×§?')) db.collection('family_contacts').doc(id).delete(); }
        function renderContacts(){ document.getElementById('contactsContainer').innerHTML=contacts.map(c=>`<div class="glass p-5 rounded-2xl hover:bg-white/5 border border-white/5 flex items-center justify-between"><div class="flex items-center gap-4"><div class="w-10 h-10 rounded-full bg-blue-500/20 text-blue-400 flex items-center justify-center font-bold text-xl">${c.name.charAt(0)}</div><div><h4 class="font-bold text-white text-lg">${c.name}</h4><p class="text-sm text-slate-400">${c.role}</p></div></div><div class="flex gap-2"><a href="tel:${c.phone}" class="w-10 h-10 rounded-full bg-green-500/20 text-green-400 flex items-center justify-center hover:bg-green-500/30"><i class="fas fa-phone"></i></a><button onclick="deleteContact('${c.id}')" class="w-10 h-10 rounded-full bg-white/5 text-slate-400 flex items-center justify-center hover:text-red-400"><i class="fas fa-trash"></i></button></div></div>`).join(''); }
        function renderTable(){ const s=document.getElementById('searchBox').value.toLowerCase(); document.getElementById('transactionsListMobile').innerHTML=items.filter(i=>(i.name||'').toLowerCase().includes(s)).sort((a,b)=>new Date(b.startDate)-new Date(a.startDate)).map(i=>`<div onclick="editItem('${i.id}')" class="glass p-4 rounded-2xl border border-white/5 flex justify-between items-center"><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full flex items-center justify-center text-xl ${i.type==='income'?'bg-green-500/20 text-green-400':'bg-red-500/20 text-red-400'}"><i class="fas ${i.type==='income'?'fa-arrow-up':'fa-arrow-down'}"></i></div><div><h4 class="font-bold text-white text-sm">${i.name}</h4><p class="text-xs text-slate-400">${i.startDate}</p></div></div><span class="font-bold font-mono text-lg ${i.type==='income'?'text-green-400':'text-red-400'}">â‚ª${Number(i.estimatedCost).toLocaleString()}</span></div>`).join(''); }
        function updateDashboard() { let inc=0, exp=0, monthStats=Array(12).fill(0).map(()=>({inc:0,exp:0})), catStats={}; items.forEach(i => { const amt = Number(i.estimatedCost)||0; const m = new Date(i.startDate||Date.now()).getMonth(); if(i.type==='income'){ inc+=amt; monthStats[m].inc+=amt; } else { exp+=amt; monthStats[m].exp+=amt; const c=i.linkedPlanName?('×¤×¨×•×™×§×˜: '+i.linkedPlanName):(i.department||'××—×¨'); catStats[c]=(catStats[c]||0)+amt; } }); document.getElementById('dashBalance').textContent='â‚ª'+(inc-exp).toLocaleString(); document.getElementById('dashIncome').textContent=inc.toLocaleString(); document.getElementById('dashExpense').textContent=exp.toLocaleString(); if(chartMonthly) chartMonthly.destroy(); chartMonthly=new Chart(document.getElementById('monthlyChart'),{type:'bar',data:{labels:['×™× ×•','×¤×‘×¨','××¨×¥','××¤×¨','×××™','×™×•× ','×™×•×œ','××•×’','×¡×¤×˜','××•×§','× ×•×‘','×“×¦×'],datasets:[{label:'×”×›× ×¡×•×ª',data:monthStats.map(s=>s.inc),backgroundColor:'#10b981',borderRadius:4},{label:'×”×•×¦××•×ª',data:monthStats.map(s=>s.exp),backgroundColor:'#ef4444',borderRadius:4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'white'}}},scales:{x:{grid:{display:false},ticks:{color:'#94a3b8'}},y:{grid:{color:'#334155'},ticks:{color:'#94a3b8'}}}}}); if(chartCategory) chartCategory.destroy(); chartCategory=new Chart(document.getElementById('categoryChart'),{type:'doughnut',data:{labels:Object.keys(catStats),datasets:[{data:Object.values(catStats),backgroundColor:['#8b5cf6','#3b82f6','#06b6d4','#10b981','#f59e0b','#ef4444'],borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,cutout:'75%',plugins:{legend:{display:false}}}}); }
        function renderPlanner(){ const c=document.getElementById('plansContainer'); c.innerHTML=plans.length===0?'<div class="col-span-full text-center py-20 text-slate-500">××™×Ÿ ×¤×¨×•×™×§×˜×™×</div>':plans.map(p=>{ const limit=Number(p.limit)||0, used=items.filter(i=>i.linkedPlanId===p.id).reduce((s,i)=>s+(Number(i.estimatedCost)||0),0), pct=limit>0?Math.min((used/limit)*100,100):0, rem=limit-used; return `<div onclick="openDetailModal('${p.id}')" class="glass p-5 rounded-2xl hover:bg-white/5 cursor-pointer relative group border border-white/5"><div class="flex justify-between mb-3"><div><h3 class="font-bold text-lg text-white">${p.name}</h3></div><div class="text-right"><p class="text-[10px] text-slate-400">×™×¢×“</p><p class="font-bold text-purple-400">â‚ª${limit.toLocaleString()}</p></div></div><div class="w-full bg-black/30 h-3 rounded-full overflow-hidden mb-3"><div class="h-full ${rem<0?'bg-red-500':'bg-gradient-to-r from-purple-500 to-blue-500'}" style="width:${pct}%"></div></div><div class="flex justify-between text-sm"><span class="text-slate-400">× ×•×¦×œ: <b>â‚ª${used.toLocaleString()}</b></span><span class="${rem<0?'text-red-400':'text-green-400'} font-bold">${rem<0?'×—×¨×™×’×”: ':'× ×•×ª×¨: '}â‚ª${Math.abs(rem).toLocaleString()}</span></div><button onclick="deletePlan('${p.id}'); event.stopPropagation();" class="absolute top-4 left-4 text-slate-600 hover:text-red-500 z-10 p-2"><i class="fas fa-trash"></i></button></div>`; }).join(''); }
        function exportToExcel(){ const ws=XLSX.utils.json_to_sheet(items.map(i=>({"×©×":i.name,"×¡×›×•×":i.estimatedCost}))); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Data"); XLSX.writeFile(wb,"HomeOS_Space.xlsx"); }
        function resetData(){ if(confirm('×”×©××“×” ×¢×¦××™×ª?')) items.concat(plans).concat(contacts).forEach(x=>db.collection(x.phone?'family_contacts':(x.limit?'family_plans':'family_transactions')).doc(x.id).delete()); }
    </script>
</body>
</html>
